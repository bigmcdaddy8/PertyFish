comChessEngineFunctions As CanvasComponent:
    fCE_100(pNodeID As Number):
        pNodeID:
            Default: =EMPTY_NODE_ID
        ThisProperty:
            Default: |
                =
                If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                        " comChessEngineFunctions.fCE_100(): entered pNodeID: " & pNodeID
                    })
                );
                
                With(
                    LookUp(colPF_DYNAMIC_DATA, dataName=DYNAMIC_DATA_PF_NAME) As theData,
                
                    With(
                        LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNode,
                
                        If(gblPF_DEBUG_EVAL,
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                " fCE_100(): san: " & theCurrentNode.inactiveColorMoveRecord.san &
                                " pacn: " & theCurrentNode.inactiveColorMoveRecord.pacn &
                                " move color: " & UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN) &
                                " captureSquareOccupier: " & theCurrentNode.inactiveColorMoveRecord.captureSquareOccupier
                            })
                        );
                
                        Patch(colPF_MOVE_TREE, First(Filter(colPF_MOVE_TREE, nodeID=pNodeID)), {
                            postMoveEvalRecord: 
                                Patch(EVAL_RECORD_PF, {
                                    // a pinch of randomness
                                    heuristic19:
                                        RandBetween(-25,25)  // centipawns 
                                })
                        });
                
                        UpdateIf(colPF_MOVE_TREE, nodeID=pNodeID, {
                            postMoveEvalRecord: 
                                Patch(LookUp(colPF_MOVE_TREE, nodeID=pNodeID).postMoveEvalRecord, {
                                    centipawn:
                                        With(
                                            LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNodeUpdated,
                                            
                                            If(gblPF_DEBUG_EVAL,
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic19 the God of Randomness BONUS/PENALTY sub-total: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic19
                                                })
                                            );
                                            // theCurrentNodeUpdated.postMoveEvalRecord.heuristic01 +
                                            // theCurrentNodeUpdated.postMoveEvalRecord.heuristic02 +
                                            // theCurrentNodeUpdated.postMoveEvalRecord.heuristic03 +
                                            // theCurrentNodeUpdated.postMoveEvalRecord.heuristic04 +
                                            // theCurrentNodeUpdated.postMoveEvalRecord.heuristic05 +
                                            // theCurrentNodeUpdated.postMoveEvalRecord.heuristic06 +
                                            // theCurrentNodeUpdated.postMoveEvalRecord.heuristic07 +
                                            // theCurrentNodeUpdated.postMoveEvalRecord.heuristic08 +
                                            // theCurrentNodeUpdated.postMoveEvalRecord.heuristic09 +
                                            // theCurrentNodeUpdated.postMoveEvalRecord.heuristic10 +
                                            // theCurrentNodeUpdated.postMoveEvalRecord.heuristic11 +
                                            // theCurrentNodeUpdated.postMoveEvalRecord.heuristic12 +
                                            // theCurrentNodeUpdated.postMoveEvalRecord.heuristic13 +
                                            // theCurrentNodeUpdated.postMoveEvalRecord.heuristic14 +
                                            // theCurrentNodeUpdated.postMoveEvalRecord.heuristic15 +
                                            // theCurrentNodeUpdated.postMoveEvalRecord.heuristic16 +
                                            // theCurrentNodeUpdated.postMoveEvalRecord.heuristic17 +
                                            // theCurrentNodeUpdated.postMoveEvalRecord.heuristic18 +
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic19
                                        )
                                })
                        })
                    );
                
                    If(gblPF_DEBUG_EVAL,
                        With(
                            LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNode,
                
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                " fCE_100(): san: " & theCurrentNode.inactiveColorMoveRecord.san &
                                " pacn: " & theCurrentNode.inactiveColorMoveRecord.pacn &
                                " centipawn: " & theCurrentNode.postMoveEvalRecord.centipawn
                            })
                        )
                    )
                );
                
                If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & " fCE_100(): exiting"})
                )
    fCE_200(pNodeID As Number):
        pNodeID:
            Default: =EMPTY_NODE_ID
        ThisProperty:
            Default: |+
                =
                If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                        " comChessEngineFunctions.fCE_200(): entered pNodeID: " & pNodeID
                    })
                );
                
                With(
                    LookUp(colPF_DYNAMIC_DATA, dataName=DYNAMIC_DATA_PF_NAME) As theData,
                
                    With(
                        LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNode,
                
                        If(gblPF_DEBUG_EVAL,
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                " fCE_200(): san: " & theCurrentNode.inactiveColorMoveRecord.san &
                                " pacn: " & theCurrentNode.inactiveColorMoveRecord.pacn &
                                " move color: " & UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN) &
                                " captureSquareOccupier: " & theCurrentNode.inactiveColorMoveRecord.captureSquareOccupier
                            })
                        );
                
                        Patch(colPF_MOVE_TREE, First(Filter(colPF_MOVE_TREE, nodeID=pNodeID)), {
                            postMoveEvalRecord: 
                                Patch(EVAL_RECORD_PF, {
                                    heuristic11:
                                        // the dumb bully part
                                        Sum(
                                            ForAll(
                                                Split(UDF_FEN_TO_PIECE_PLACEMENT(theCurrentNode.postMoveFEN), "") As thePiece,
                
                                                UDF_getPieceCentipawnMaterialValue(thePiece.Value, "QRBNPqrbnp")
                                            ),
                                            Value
                                        ) -
                                        Sum(
                                            ForAll(
                                                Split(UDF_FEN_TO_PIECE_PLACEMENT(theCurrentNode.preMoveFEN), "") As thePiece,
                
                                                UDF_getPieceCentipawnMaterialValue(thePiece.Value, "QRBNPqrbnp")
                                            ),
                                            Value
                                        ),
                                    heuristic19:
                                        // add a touch of randomness
                                        RandBetween(-5,5)
                                })
                        });
                
                        UpdateIf(colPF_MOVE_TREE, nodeID=pNodeID, {
                            postMoveEvalRecord: 
                                Patch(LookUp(colPF_MOVE_TREE, nodeID=pNodeID).postMoveEvalRecord, {
                                    centipawn:
                                        With(
                                            LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNodeUpdated,
                                            
                                            If(gblPF_DEBUG_EVAL,
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic11 Basic Material BONUS/PENALTY sub-total: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic11
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic19 the God of Randomness BONUS/PENALTY sub-total: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic19
                                                })
                                            );
                                            Sum(
                                                theCurrentNodeUpdated.postMoveEvalRecord.heuristic11,
                                                theCurrentNodeUpdated.postMoveEvalRecord.heuristic19
                                            )
                                        )
                                })
                        })
                    );
                
                    If(gblPF_DEBUG_EVAL,
                        With(
                            LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNode,
                
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                " fCE_200(): san: " & theCurrentNode.inactiveColorMoveRecord.san &
                                " pacn: " & theCurrentNode.inactiveColorMoveRecord.pacn &
                                " centipawn: " & theCurrentNode.postMoveEvalRecord.centipawn
                            })
                        )
                    )
                );
                
                If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & " fCE_200(): exiting"})
                )
                
    fCE_300(pNodeID As Number):
        pNodeID:
            Default: =EMPTY_NODE_ID
        ThisProperty:
            Default: |+
                =
                If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                        " comChessEngineFunctions.fCE_300(): entered pNodeID: " & pNodeID
                    })
                );
                
                With(
                    LookUp(colPF_DYNAMIC_DATA, dataName=DYNAMIC_DATA_PF_NAME) As theData,
                
                    With(
                        LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNode,
                
                        If(gblPF_DEBUG_EVAL,
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                " fCE_300(): san: " & theCurrentNode.inactiveColorMoveRecord.san &
                                " pacn: " & theCurrentNode.inactiveColorMoveRecord.pacn &
                                " move color: " & UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN) &
                                " captureSquareOccupier: " & theCurrentNode.inactiveColorMoveRecord.captureSquareOccupier
                            })
                        );
                
                        Patch(colPF_MOVE_TREE, First(Filter(colPF_MOVE_TREE, nodeID=pNodeID)), {
                            postMoveEvalRecord: 
                                Patch(EVAL_RECORD_PF, {
                                    heuristic11:
                                        // the dumb bully part
                                        Sum(
                                            ForAll(
                                                Split(UDF_FEN_TO_PIECE_PLACEMENT(theCurrentNode.postMoveFEN), "") As thePiece,
                
                                                UDF_getPieceCentipawnMaterialValue(thePiece.Value, "QRBNPqrbnp")
                                            ),
                                            Value
                                        ) -
                                        Sum(
                                            ForAll(
                                                Split(UDF_FEN_TO_PIECE_PLACEMENT(theCurrentNode.preMoveFEN), "") As thePiece,
                
                                                UDF_getPieceCentipawnMaterialValue(thePiece.Value, "QRBNPqrbnp")
                                            ),
                                            Value
                                        ),
                                    heuristic17:
                                        If(UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)=WHITE,
                                            // THEN
                                            If(gblPF_DEBUG_EVAL,
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                    " fCE_300(): DEBUG heuristic17 preMove active color WHITE " & 
                                                    " # of BLACK pieces: " & UDF_countPiecesOnBoard(theCurrentNode.preMoveBoard, BLACK_PIECES)
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                    " preMoveFEN: " & theCurrentNode.preMoveFEN
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                    " preMoveBoard: " & theCurrentNode.preMoveBoard
                                                })
                                            );
                                            If(UDF_countPiecesOnBoard(theCurrentNode.preMoveBoard, BLACK_PIECES)>1,
                                                // THEN
                                                0,
                
                                                // ELSE - the opponent is a lone king
                                                Sum(
                                                    With(
                                                        {
                                                            sqNum:      UDF_SearchBoardForPiece(theCurrentNode.preMoveBoard, UDF_getICPieceABBR(theCurrentNode.preMoveFEN, "k"))
                                                        } As theirKing,
                
                                                        With(
                                                            {
                                                                adjSquaresSet: UDF_createSetOfSqNames(UDF_sqNumToAdjacentSqNamesSet(theirKing.sqNum) & " " & UDF_sqNumToSqName(theirKing.sqNum)),
                                                                noKingPreMoveBoard: UDF_setBitAtSqNum(
                                                                                        theCurrentNode.preMoveBoard,
                                                                                        EMPTY_FILLER_ABBR,
                                                                                        UDF_SearchBoardForPiece(theCurrentNode.preMoveBoard, "k")
                                                                                    ),
                                                                noKingPostMoveBoard:    UDF_setBitAtSqNum(
                                                                                            theCurrentNode.postMoveBoard,
                                                                                            EMPTY_FILLER_ABBR,
                                                                                            UDF_SearchBoardForPiece(theCurrentNode.postMoveBoard, "k")
                                                                                        ),
                                                                // remove the moving piece so that we can determine if we can move to an adjacent protected square
                                                                noKingNoPiecePreMoveBoard:  UDF_setBitAtSqNum(
                                                                                                UDF_setBitAtSqNum(
                                                                                                    theCurrentNode.preMoveBoard,
                                                                                                    EMPTY_FILLER_ABBR,
                                                                                                    theCurrentNode.inactiveColorMoveRecord.sourceSquareNum
                                                                                                ),
                                                                                                EMPTY_FILLER_ABBR,
                                                                                                UDF_SearchBoardForPiece(theCurrentNode.preMoveBoard,"k")
                                                                                            ),
                                                                noKingNoPiecePostMoveBoard: UDF_setBitAtSqNum(
                                                                                                UDF_setBitAtSqNum(
                                                                                                    theCurrentNode.postMoveBoard,
                                                                                                    EMPTY_FILLER_ABBR,
                                                                                                    theCurrentNode.inactiveColorMoveRecord.targetSquareNum
                                                                                                ),
                                                                                                EMPTY_FILLER_ABBR,
                                                                                                UDF_SearchBoardForPiece(theCurrentNode.postMoveBoard,"k")
                                                                                            )
                                                            } As adjToTheirKing,
                
                                                            If(gblPF_DEBUG_EVAL,
                                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                    " fCE_300(): heuristic17 opponent kingSq: " & UDF_sqNumToSqName(theirKing.sqNum) & "(" & theirKing.sqNum & ")" &
                                                                    " Black King adj set: " & adjToTheirKing.adjSquaresSet
                                                                })
                                                            );
                                                            If((!(theCurrentNode.inactiveColorMoveRecord.targetSquareName exactin adjToTheirKing.adjSquaresSet)) ||
                                                                UDF_isSqNumAttacked(
                                                                    adjToTheirKing.noKingNoPiecePostMoveBoard,
                                                                    theCurrentNode.inactiveColorMoveRecord.targetSquareNum,
                                                                    WHITE
                                                                ),
                                                                // THEN
                                                                If(gblPF_DEBUG_EVAL,
                                                                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                        " fCE_300(): heuristic17 looking to encourage move if it qualifies targetSqName: " & theCurrentNode.inactiveColorMoveRecord.targetSquareNum
                                                                    })
                                                                );
                                                                Sum(
                                                                    ForAll(
                                                                        Split(adjToTheirKing.adjSquaresSet, " ") As adjSquareName,
                
                                                                        With(
                                                                            {
                                                                                preMoveIsAttacked:  UDF_isSqNumAttacked(adjToTheirKing.noKingPreMoveBoard, UDF_sqNameToSqNum(adjSquareName.Value), WHITE),
                                                                                postMoveIsAttacked: UDF_isSqNumAttacked(adjToTheirKing.noKingPostMoveBoard, UDF_sqNameToSqNum(adjSquareName.Value), WHITE)
                                                                            } As attackBooleans,
                
                                                                            If(gblPF_DEBUG_EVAL,
                                                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                                    " Black King adjSquareName: " & adjSquareName.Value & "(" & UDF_sqNameToSqNum(adjSquareName.Value) & ")" &
                                                                                        " preMove isAttacked?: " & attackBooleans.preMoveIsAttacked &
                                                                                        " postMove isAttacked?: " & attackBooleans.postMoveIsAttacked
                                                                                })
                                                                            );
                                                                            Switch(true,
                                                                                attackBooleans.preMoveIsAttacked=false && attackBooleans.postMoveIsAttacked=true, 1,
                                                                                attackBooleans.preMoveIsAttacked=true && attackBooleans.postMoveIsAttacked=false, -1,
                                                                                
                                                                                // default
                                                                                0
                                                                            )
                                                                        )
                                                                    ), Value
                                                                ) * 21,
                
                                                                // ELSE
                                                                If(theCurrentNode.inactiveColorMoveRecord.targetSquareName exactin adjToTheirKing.adjSquaresSet,
                                                                    // THEN
                                                                    If(gblPF_DEBUG_EVAL,
                                                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                            " fCE_300(): heuristic17 discouraging move to naked adj square targetSqName: " &
                                                                                theCurrentNode.inactiveColorMoveRecord.targetSquareNum
                                                                        })
                                                                    );
                                                                    -21, // do not want to move there - will be captured,
                
                                                                    // ELSE
                                                                    If(gblPF_DEBUG_EVAL,
                                                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                            " fCE_300(): heuristic17 neutral targetSqName: " & theCurrentNode.inactiveColorMoveRecord.targetSquareNum
                                                                        })
                                                                    );
                                                                    0
                                                                )
                                                            )
                
                                                        )
                                                    ),
                                                    // - push the pawns forward (until we have enough Qs) - is this a pawn move ?
                                                    If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "P" && UDF_countPiecesOnBoard(theCurrentNode.preMoveBoard, "Q")<3,
                                                        // THEN - bump up the promotion to a Q
                                                        If(IsBlank(theCurrentNode.inactiveColorMoveRecord.promoteTo) || theCurrentNode.inactiveColorMoveRecord.promoteTo in "Q",
                                                            UDF_getRankFromSqName(theCurrentNode.inactiveColorMoveRecord.targetSquareName) * RandBetween(8,18),
                                                            0
                                                        ),
                                                        // ELSE
                                                        0
                                                    )
                                                )
                                            ),
                
                                            // ELSE
                                            If(gblPF_DEBUG_EVAL,
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                    " fCE_300(): DEBUG heuristic17 preMove active color BLACK " & 
                                                    " # of WHITE pieces: " & UDF_countPiecesOnBoard(theCurrentNode.preMoveBoard, WHITE_PIECES)
                                                })
                                            );
                                            If(UDF_countPiecesOnBoard(theCurrentNode.preMoveBoard, WHITE_PIECES)>1,
                                                // THEN
                                                0,
                
                                                // ELSE - the opponent is a lone king 
                                                Sum(
                                                    With(
                                                        {
                                                            sqNum:      UDF_SearchBoardForPiece(theCurrentNode.preMoveBoard, UDF_getICPieceABBR(theCurrentNode.preMoveFEN, "K"))
                                                        } As theirKing,
                
                                                        With(
                                                            {
                                                                adjSquaresSet: UDF_createSetOfSqNames(UDF_sqNumToAdjacentSqNamesSet(theirKing.sqNum) & " " & UDF_sqNumToSqName(theirKing.sqNum)),
                                                                noKingPreMoveBoard: UDF_setBitAtSqNum(
                                                                                        theCurrentNode.preMoveBoard,
                                                                                        EMPTY_FILLER_ABBR,
                                                                                        UDF_SearchBoardForPiece(theCurrentNode.preMoveBoard, "K")
                                                                                    ),
                                                                noKingPostMoveBoard:    UDF_setBitAtSqNum(
                                                                                            theCurrentNode.postMoveBoard,
                                                                                            EMPTY_FILLER_ABBR,
                                                                                            UDF_SearchBoardForPiece(theCurrentNode.postMoveBoard, "K")
                                                                                        ),
                                                                // remove the moving piece so that we can determine if we can move to an adjacent protected square
                                                                noKingNoPiecePreMoveBoard:  UDF_setBitAtSqNum(
                                                                                                UDF_setBitAtSqNum(
                                                                                                    theCurrentNode.preMoveBoard,
                                                                                                    EMPTY_FILLER_ABBR,
                                                                                                    theCurrentNode.inactiveColorMoveRecord.sourceSquareNum
                                                                                                ),
                                                                                                EMPTY_FILLER_ABBR,
                                                                                                UDF_SearchBoardForPiece(theCurrentNode.preMoveBoard,"K")
                                                                                            ),
                                                                noKingNoPiecePostMoveBoard: UDF_setBitAtSqNum(
                                                                                                UDF_setBitAtSqNum(
                                                                                                    theCurrentNode.postMoveBoard,
                                                                                                    EMPTY_FILLER_ABBR,
                                                                                                    theCurrentNode.inactiveColorMoveRecord.targetSquareNum
                                                                                                ),
                                                                                                EMPTY_FILLER_ABBR,
                                                                                                UDF_SearchBoardForPiece(theCurrentNode.postMoveBoard,"K")
                                                                                            )
                                                            } As adjToTheirKing,
                
                                                            If(gblPF_DEBUG_EVAL,
                                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                    " fCE_300(): heuristic17 opponent kingSq: " & UDF_sqNumToSqName(theirKing.sqNum) & "(" & theirKing.sqNum & ")" &
                                                                    " White King adj set: " & adjToTheirKing.adjSquaresSet
                                                                })
                                                            );
                                                            If((!(theCurrentNode.inactiveColorMoveRecord.targetSquareName exactin adjToTheirKing.adjSquaresSet)) ||
                                                                UDF_isSqNumAttacked(
                                                                    adjToTheirKing.noKingNoPiecePostMoveBoard,
                                                                    theCurrentNode.inactiveColorMoveRecord.targetSquareNum,
                                                                    BLACK
                                                                ),
                                                                // THEN
                                                                If(gblPF_DEBUG_EVAL,
                                                                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                        " fCE_300(): heuristic17 looking to encourage move if it qualifies targetSqName: " & theCurrentNode.inactiveColorMoveRecord.targetSquareNum
                                                                    })
                                                                );
                                                                Sum(
                                                                    ForAll(
                                                                        Split(adjToTheirKing.adjSquaresSet, " ") As adjSquareName,
                
                                                                        With(
                                                                            {
                                                                                preMoveIsAttacked:  UDF_isSqNumAttacked(adjToTheirKing.noKingPreMoveBoard, UDF_sqNameToSqNum(adjSquareName.Value), BLACK),
                                                                                postMoveIsAttacked: UDF_isSqNumAttacked(adjToTheirKing.noKingPostMoveBoard, UDF_sqNameToSqNum(adjSquareName.Value), BLACK)
                                                                            } As attackBooleans,
                
                                                                            If(gblPF_DEBUG_EVAL,
                                                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                                    " White King adjSquareName: " & adjSquareName.Value & "(" & UDF_sqNameToSqNum(adjSquareName.Value) & ")" &
                                                                                        " preMove isAttacked?: " & attackBooleans.preMoveIsAttacked &
                                                                                        " postMove isAttacked?: " & attackBooleans.postMoveIsAttacked
                                                                                })
                                                                            );
                                                                            Switch(true,
                                                                                attackBooleans.preMoveIsAttacked=false && attackBooleans.postMoveIsAttacked=true, 1,
                                                                                attackBooleans.preMoveIsAttacked=true && attackBooleans.postMoveIsAttacked=false, -1,
                                                                                
                                                                                // default
                                                                                0
                                                                            )
                                                                        )
                                                                    ), Value
                                                                ) * -21,
                
                                                                // ELSE
                                                                If(theCurrentNode.inactiveColorMoveRecord.targetSquareName exactin adjToTheirKing.adjSquaresSet,
                                                                    // THEN
                                                                    If(gblPF_DEBUG_EVAL,
                                                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                            " fCE_300(): heuristic17 discouraging move to naked adj square targetSqName: " &
                                                                                theCurrentNode.inactiveColorMoveRecord.targetSquareNum
                                                                        })
                                                                    );
                                                                    21, // do not want to move there - will be captured,
                
                                                                    // ELSE
                                                                    If(gblPF_DEBUG_EVAL,
                                                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                            " fCE_300(): heuristic17 neutral targetSqName: " &
                                                                                theCurrentNode.inactiveColorMoveRecord.targetSquareNum
                                                                        })
                                                                    );
                                                                    0
                                                                )
                                                            )
                                                        )
                                                    ),
                                                    // push the pawns forward (until we have enough Qs) - is this a pawn move ?
                                                    If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "P" && UDF_countPiecesOnBoard(theCurrentNode.preMoveBoard, "q")<3,
                                                        // THEN - bump up the promotion to a Q
                                                        If(IsBlank(theCurrentNode.inactiveColorMoveRecord.promoteTo) || theCurrentNode.inactiveColorMoveRecord.promoteTo in "Q",
                                                            (8 - UDF_getRankFromSqName(theCurrentNode.inactiveColorMoveRecord.targetSquareName)) * RandBetween(-18,-8),
                                                            0
                                                        ),
                                                        // ELSE
                                                        0
                                                    )
                                                )
                                            )
                                        ),
                                    heuristic18:
                                        // add some order
                                        If(UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)=WHITE,
                                            // THEN
                                            Switch(comChessEngineFunctions.fME_getGamePhase(theCurrentNode.preMoveFEN),
                                                GAME_PHASE_OPENING,
                                                    If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "NP", RandBetween(-5,15), 0),
                                                GAME_PHASE_MIDDLE,
                                                    If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "QBNP", RandBetween(-5,15), 0),
                                                If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "QR", RandBetween(-5,15), 0)
                                            ),
                
                                            // ELSE
                                            Switch(comChessEngineFunctions.fME_getGamePhase(theCurrentNode.preMoveFEN),
                                                GAME_PHASE_OPENING,
                                                    If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "NP", RandBetween(-15,5), 0),
                                                GAME_PHASE_MIDDLE,
                                                    If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "QBNP", RandBetween(-15,5), 0),
                                                If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "QR", RandBetween(-15,5), 0)
                                            )
                                        ),
                                    heuristic19:
                                        RandBetween(-8,8)
                
                                })
                        });
                
                        UpdateIf(colPF_MOVE_TREE, nodeID=pNodeID, {
                            postMoveEvalRecord: 
                                Patch(LookUp(colPF_MOVE_TREE, nodeID=pNodeID).postMoveEvalRecord, {
                                    centipawn:
                                        With(
                                            LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNodeUpdated,
                                            
                                            If(gblPF_DEBUG_EVAL,
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic11: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic11
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic17: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic17
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic18: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic18
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic19 the God of Randomness BONUS/PENALTY sub-total: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic19
                                                })
                                            );
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic11 +
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic17 +
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic18 +
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic19
                                        )
                                })
                        })
                    );
                
                    If(gblPF_DEBUG_EVAL,
                        With(
                            LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNode,
                
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                " fCE_300(): san: " & theCurrentNode.inactiveColorMoveRecord.san &
                                " pacn: " & theCurrentNode.inactiveColorMoveRecord.pacn &
                                " centipawn: " & theCurrentNode.postMoveEvalRecord.centipawn
                            })
                        )
                    )
                );
                
                If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & " fCE_300(): exiting"})
                )
                
    fCE_400(pNodeID As Number):
        pNodeID:
            Default: =EMPTY_NODE_ID
        ThisProperty:
            Default: |+
                =
                If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                        " comChessEngineFunctions.fCE_400(): entered pNodeID: " & pNodeID
                    })
                );
                
                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                    " comChessEngineFunctions.fCE_400(): entered2 pNodeID: " & pNodeID
                });
                
                With(
                    LookUp(colPF_DYNAMIC_DATA, dataName=DYNAMIC_DATA_PF_NAME) As theData,
                
                    With(
                        LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNode,
                
                        If(gblPF_DEBUG_EVAL,
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                " fCE_400(): san: " & theCurrentNode.inactiveColorMoveRecord.san &
                                " pacn: " & theCurrentNode.inactiveColorMoveRecord.pacn &
                                " move color: " & UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN) &
                                " captureSquareOccupier: " & theCurrentNode.inactiveColorMoveRecord.captureSquareOccupier
                            })
                        );
                
                        Patch(colPF_MOVE_TREE, First(Filter(colPF_MOVE_TREE, nodeID=pNodeID)), {
                            postMoveEvalRecord: 
                                Patch(EVAL_RECORD_PF, {
                                    heuristic11:
                                        With(
                                            {
                                                materialDelta:
                                                    Sum(
                                                        ForAll(
                                                            Split(UDF_FEN_TO_PIECE_PLACEMENT(theCurrentNode.postMoveFEN), "") As thePiece,
                
                                                            UDF_getPieceCentipawnMaterialValue(thePiece.Value, "QRBNPqrbnp")
                                                        ),
                                                        Value
                                                    ) -
                                                    Sum(
                                                        ForAll(
                                                            Split(UDF_FEN_TO_PIECE_PLACEMENT(theCurrentNode.preMoveFEN), "") As thePiece,
                
                                                            UDF_getPieceCentipawnMaterialValue(thePiece.Value, "QRBNPqrbnp")
                                                        ),
                                                        Value
                                                    ),
                                                materialSource:
                                                    UDF_getPieceCentipawnMaterialValue(
                                                        theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier,
                                                        ALL_PIECES
                                                    ),
                                                materialCapture: 
                                                    UDF_getPieceCentipawnMaterialValue(
                                                        theCurrentNode.inactiveColorMoveRecord.captureSquareOccupier,
                                                        ALL_PIECES
                                                    ),
                                                targetSqAttacked:
                                                    UDF_isSqNumAttacked(
                                                        theCurrentNode.postMoveBoard,
                                                        theCurrentNode.inactiveColorMoveRecord.targetSquareNum,
                                                        UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.postMoveFEN)
                                                    )
                                            } As localVars,
                
                                            If(!localVars.targetSqAttacked || (Abs(localVars.materialSource)<Abs(localVars.materialCapture)),
                                                // THEN
                                                localVars.materialDelta,
                
                                                // ELSE - discourage the move
                                                If(UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)=WHITE,-25,25)
                                            )
                                        ),
                
                                    heuristic17:
                                        If(UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)=WHITE,
                                            // THEN
                                            If(gblPF_DEBUG_EVAL,
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                    " fCE_400(): DEBUG heuristic17 preMove active color WHITE " & 
                                                    " # of BLACK pieces: " & UDF_countPiecesOnBoard(theCurrentNode.preMoveBoard, BLACK_PIECES)
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                    " preMoveFEN: " & theCurrentNode.preMoveFEN
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                    " preMoveBoard: " & theCurrentNode.preMoveBoard
                                                })
                                            );
                                            If(UDF_countPiecesOnBoard(theCurrentNode.preMoveBoard, BLACK_PIECES)>1,
                                                // THEN
                                                0,
                
                                                // ELSE - the opponent is a lone king
                                                Sum(
                                                    With(
                                                        {
                                                            sqNum:      UDF_SearchBoardForPiece(theCurrentNode.preMoveBoard, UDF_getICPieceABBR(theCurrentNode.preMoveFEN, "k"))
                                                        } As theirKing,
                
                                                        With(
                                                            {
                                                                adjSquaresSet: UDF_createSetOfSqNames(UDF_sqNumToAdjacentSqNamesSet(theirKing.sqNum) & " " & UDF_sqNumToSqName(theirKing.sqNum)),
                                                                noKingPreMoveBoard: UDF_setBitAtSqNum(
                                                                                        theCurrentNode.preMoveBoard,
                                                                                        EMPTY_FILLER_ABBR,
                                                                                        UDF_SearchBoardForPiece(theCurrentNode.preMoveBoard, "k")
                                                                                    ),
                                                                noKingPostMoveBoard:    UDF_setBitAtSqNum(
                                                                                            theCurrentNode.postMoveBoard,
                                                                                            EMPTY_FILLER_ABBR,
                                                                                            UDF_SearchBoardForPiece(theCurrentNode.postMoveBoard, "k")
                                                                                        ),
                                                                // remove the moving piece so that we can determine if we can move to an adjacent protected square
                                                                noKingNoPiecePreMoveBoard:  UDF_setBitAtSqNum(
                                                                                                UDF_setBitAtSqNum(
                                                                                                    theCurrentNode.preMoveBoard,
                                                                                                    EMPTY_FILLER_ABBR,
                                                                                                    theCurrentNode.inactiveColorMoveRecord.sourceSquareNum
                                                                                                ),
                                                                                                EMPTY_FILLER_ABBR,
                                                                                                UDF_SearchBoardForPiece(theCurrentNode.preMoveBoard,"k")
                                                                                            ),
                                                                noKingNoPiecePostMoveBoard: UDF_setBitAtSqNum(
                                                                                                UDF_setBitAtSqNum(
                                                                                                    theCurrentNode.postMoveBoard,
                                                                                                    EMPTY_FILLER_ABBR,
                                                                                                    theCurrentNode.inactiveColorMoveRecord.targetSquareNum
                                                                                                ),
                                                                                                EMPTY_FILLER_ABBR,
                                                                                                UDF_SearchBoardForPiece(theCurrentNode.postMoveBoard,"k")
                                                                                            )
                                                            } As adjToTheirKing,
                
                                                            If(gblPF_DEBUG_EVAL,
                                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                    " fCE_400(): heuristic17 opponent kingSq: " & UDF_sqNumToSqName(theirKing.sqNum) & "(" & theirKing.sqNum & ")" &
                                                                    " Black King adj set: " & adjToTheirKing.adjSquaresSet
                                                                })
                                                            );
                                                            If((!(theCurrentNode.inactiveColorMoveRecord.targetSquareName exactin adjToTheirKing.adjSquaresSet)) ||
                                                                UDF_isSqNumAttacked(
                                                                    adjToTheirKing.noKingNoPiecePostMoveBoard,
                                                                    theCurrentNode.inactiveColorMoveRecord.targetSquareNum,
                                                                    WHITE
                                                                ),
                                                                // THEN
                                                                If(gblPF_DEBUG_EVAL,
                                                                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                        " fCE_400(): heuristic17 looking to encourage move if it qualifies targetSqName: " & theCurrentNode.inactiveColorMoveRecord.targetSquareNum
                                                                    })
                                                                );
                                                                Sum(
                                                                    ForAll(
                                                                        Split(adjToTheirKing.adjSquaresSet, " ") As adjSquareName,
                
                                                                        With(
                                                                            {
                                                                                preMoveIsAttacked:  UDF_isSqNumAttacked(adjToTheirKing.noKingPreMoveBoard, UDF_sqNameToSqNum(adjSquareName.Value), WHITE),
                                                                                postMoveIsAttacked: UDF_isSqNumAttacked(adjToTheirKing.noKingPostMoveBoard, UDF_sqNameToSqNum(adjSquareName.Value), WHITE)
                                                                            } As attackBooleans,
                
                                                                            If(gblPF_DEBUG_EVAL,
                                                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                                    " Black King adjSquareName: " & adjSquareName.Value & "(" & UDF_sqNameToSqNum(adjSquareName.Value) & ")" &
                                                                                        " preMove isAttacked?: " & attackBooleans.preMoveIsAttacked &
                                                                                        " postMove isAttacked?: " & attackBooleans.postMoveIsAttacked
                                                                                })
                                                                            );
                                                                            Switch(true,
                                                                                attackBooleans.preMoveIsAttacked=false && attackBooleans.postMoveIsAttacked=true, 1,
                                                                                attackBooleans.preMoveIsAttacked=true && attackBooleans.postMoveIsAttacked=false, -1,
                                                                                
                                                                                // default
                                                                                0
                                                                            )
                                                                        )
                                                                    ), Value
                                                                ) * 21,
                
                                                                // ELSE
                                                                If(theCurrentNode.inactiveColorMoveRecord.targetSquareName exactin adjToTheirKing.adjSquaresSet,
                                                                    // THEN
                                                                    If(gblPF_DEBUG_EVAL,
                                                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                            " fCE_400(): heuristic17 discouraging move to naked adj square targetSqName: " &
                                                                                theCurrentNode.inactiveColorMoveRecord.targetSquareNum
                                                                        })
                                                                    );
                                                                    -21, // do not want to move there - will be captured,
                
                                                                    // ELSE
                                                                    If(gblPF_DEBUG_EVAL,
                                                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                            " fCE_400(): heuristic17 neutral targetSqName: " & theCurrentNode.inactiveColorMoveRecord.targetSquareNum
                                                                        })
                                                                    );
                                                                    0
                                                                )
                                                            )
                
                                                        )
                                                    ),
                                                    // - push the pawns forward (until we have enough Qs) - is this a pawn move ?
                                                    If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "P" && UDF_countPiecesOnBoard(theCurrentNode.preMoveBoard, "Q")<3,
                                                        // THEN - bump up the promotion to a Q
                                                        If(IsBlank(theCurrentNode.inactiveColorMoveRecord.promoteTo) || theCurrentNode.inactiveColorMoveRecord.promoteTo in "Q",
                                                            UDF_getRankFromSqName(theCurrentNode.inactiveColorMoveRecord.targetSquareName) * RandBetween(8,18),
                                                            0
                                                        ),
                                                        // ELSE
                                                        0
                                                    )
                                                )
                                            ),
                
                                            // ELSE
                                            If(gblPF_DEBUG_EVAL,
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                    " fCE_400(): DEBUG heuristic17 preMove active color BLACK " & 
                                                    " # of WHITE pieces: " & UDF_countPiecesOnBoard(theCurrentNode.preMoveBoard, WHITE_PIECES)
                                                })
                                            );
                                            If(UDF_countPiecesOnBoard(theCurrentNode.preMoveBoard, WHITE_PIECES)>1,
                                                // THEN
                                                0,
                
                                                // ELSE - the opponent is a lone king 
                                                Sum(
                                                    With(
                                                        {
                                                            sqNum:      UDF_SearchBoardForPiece(theCurrentNode.preMoveBoard, UDF_getICPieceABBR(theCurrentNode.preMoveFEN, "K"))
                                                        } As theirKing,
                
                                                        With(
                                                            {
                                                                adjSquaresSet: UDF_createSetOfSqNames(UDF_sqNumToAdjacentSqNamesSet(theirKing.sqNum) & " " & UDF_sqNumToSqName(theirKing.sqNum)),
                                                                noKingPreMoveBoard: UDF_setBitAtSqNum(
                                                                                        theCurrentNode.preMoveBoard,
                                                                                        EMPTY_FILLER_ABBR,
                                                                                        UDF_SearchBoardForPiece(theCurrentNode.preMoveBoard, "K")
                                                                                    ),
                                                                noKingPostMoveBoard:    UDF_setBitAtSqNum(
                                                                                            theCurrentNode.postMoveBoard,
                                                                                            EMPTY_FILLER_ABBR,
                                                                                            UDF_SearchBoardForPiece(theCurrentNode.postMoveBoard, "K")
                                                                                        ),
                                                                // remove the moving piece so that we can determine if we can move to an adjacent protected square
                                                                noKingNoPiecePreMoveBoard:  UDF_setBitAtSqNum(
                                                                                                UDF_setBitAtSqNum(
                                                                                                    theCurrentNode.preMoveBoard,
                                                                                                    EMPTY_FILLER_ABBR,
                                                                                                    theCurrentNode.inactiveColorMoveRecord.sourceSquareNum
                                                                                                ),
                                                                                                EMPTY_FILLER_ABBR,
                                                                                                UDF_SearchBoardForPiece(theCurrentNode.preMoveBoard,"K")
                                                                                            ),
                                                                noKingNoPiecePostMoveBoard: UDF_setBitAtSqNum(
                                                                                                UDF_setBitAtSqNum(
                                                                                                    theCurrentNode.postMoveBoard,
                                                                                                    EMPTY_FILLER_ABBR,
                                                                                                    theCurrentNode.inactiveColorMoveRecord.targetSquareNum
                                                                                                ),
                                                                                                EMPTY_FILLER_ABBR,
                                                                                                UDF_SearchBoardForPiece(theCurrentNode.postMoveBoard,"K")
                                                                                            )
                                                            } As adjToTheirKing,
                
                                                            If(gblPF_DEBUG_EVAL,
                                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                    " fCE_400(): heuristic17 opponent kingSq: " & UDF_sqNumToSqName(theirKing.sqNum) & "(" & theirKing.sqNum & ")" &
                                                                    " White King adj set: " & adjToTheirKing.adjSquaresSet
                                                                })
                                                            );
                                                            If((!(theCurrentNode.inactiveColorMoveRecord.targetSquareName exactin adjToTheirKing.adjSquaresSet)) ||
                                                                UDF_isSqNumAttacked(
                                                                    adjToTheirKing.noKingNoPiecePostMoveBoard,
                                                                    theCurrentNode.inactiveColorMoveRecord.targetSquareNum,
                                                                    BLACK
                                                                ),
                                                                // THEN
                                                                If(gblPF_DEBUG_EVAL,
                                                                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                        " fCE_400(): heuristic17 looking to encourage move if it qualifies targetSqName: " & theCurrentNode.inactiveColorMoveRecord.targetSquareNum
                                                                    })
                                                                );
                                                                Sum(
                                                                    ForAll(
                                                                        Split(adjToTheirKing.adjSquaresSet, " ") As adjSquareName,
                
                                                                        With(
                                                                            {
                                                                                preMoveIsAttacked:  UDF_isSqNumAttacked(adjToTheirKing.noKingPreMoveBoard, UDF_sqNameToSqNum(adjSquareName.Value), BLACK),
                                                                                postMoveIsAttacked: UDF_isSqNumAttacked(adjToTheirKing.noKingPostMoveBoard, UDF_sqNameToSqNum(adjSquareName.Value), BLACK)
                                                                            } As attackBooleans,
                
                                                                            If(gblPF_DEBUG_EVAL,
                                                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                                    " White King adjSquareName: " & adjSquareName.Value & "(" & UDF_sqNameToSqNum(adjSquareName.Value) & ")" &
                                                                                        " preMove isAttacked?: " & attackBooleans.preMoveIsAttacked &
                                                                                        " postMove isAttacked?: " & attackBooleans.postMoveIsAttacked
                                                                                })
                                                                            );
                                                                            Switch(true,
                                                                                attackBooleans.preMoveIsAttacked=false && attackBooleans.postMoveIsAttacked=true, 1,
                                                                                attackBooleans.preMoveIsAttacked=true && attackBooleans.postMoveIsAttacked=false, -1,
                                                                                
                                                                                // default
                                                                                0
                                                                            )
                                                                        )
                                                                    ), Value
                                                                ) * -21,
                
                                                                // ELSE
                                                                If(theCurrentNode.inactiveColorMoveRecord.targetSquareName exactin adjToTheirKing.adjSquaresSet,
                                                                    // THEN
                                                                    If(gblPF_DEBUG_EVAL,
                                                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                            " fCE_400(): heuristic17 discouraging move to naked adj square targetSqName: " &
                                                                                theCurrentNode.inactiveColorMoveRecord.targetSquareNum
                                                                        })
                                                                    );
                                                                    21, // do not want to move there - will be captured,
                
                                                                    // ELSE
                                                                    If(gblPF_DEBUG_EVAL,
                                                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                            " fCE_400(): heuristic17 neutral targetSqName: " &
                                                                                theCurrentNode.inactiveColorMoveRecord.targetSquareNum
                                                                        })
                                                                    );
                                                                    0
                                                                )
                                                            )
                                                        )
                                                    ),
                                                    // push the pawns forward (until we have enough Qs) - is this a pawn move ?
                                                    If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "P" && UDF_countPiecesOnBoard(theCurrentNode.preMoveBoard, "q")<3,
                                                        // THEN - bump up the promotion to a Q
                                                        If(IsBlank(theCurrentNode.inactiveColorMoveRecord.promoteTo) || theCurrentNode.inactiveColorMoveRecord.promoteTo in "Q",
                                                            (8 - UDF_getRankFromSqName(theCurrentNode.inactiveColorMoveRecord.targetSquareName)) * RandBetween(-18,-8),
                                                            0
                                                        ),
                                                        // ELSE
                                                        0
                                                    )
                                                )
                                            )
                                        ),
                                    heuristic18:
                                        // add some order
                                        If(UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)=WHITE,
                                            // THEN
                                            Switch(comChessEngineFunctions.fME_getGamePhase(theCurrentNode.preMoveFEN),
                                                GAME_PHASE_OPENING,
                                                    If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "NP", RandBetween(-5,15), 0),
                                                GAME_PHASE_MIDDLE,
                                                    If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "QBNP", RandBetween(-5,15), 0),
                                                If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "QR", RandBetween(-5,15), 0)
                                            ),
                
                                            // ELSE
                                            Switch(comChessEngineFunctions.fME_getGamePhase(theCurrentNode.preMoveFEN),
                                                GAME_PHASE_OPENING,
                                                    If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "NP", RandBetween(-15,5), 0),
                                                GAME_PHASE_MIDDLE,
                                                    If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "QBNP", RandBetween(-15,5), 0),
                                                If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "QR", RandBetween(-15,5), 0)
                                            )
                                        ),
                                    heuristic19:
                                        RandBetween(-8,8)
                
                                })
                        });
                
                        UpdateIf(colPF_MOVE_TREE, nodeID=pNodeID, {
                            postMoveEvalRecord: 
                                Patch(LookUp(colPF_MOVE_TREE, nodeID=pNodeID).postMoveEvalRecord, {
                                    centipawn:
                                        With(
                                            LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNodeUpdated,
                                            
                                            If(gblPF_DEBUG_EVAL,
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic11: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic11
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic17: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic17
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic18: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic18
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic19 the God of Randomness BONUS/PENALTY sub-total: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic19
                                                })
                                            );
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic11 +
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic17 +
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic18 +
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic19
                                        )
                                })
                        })
                    );
                
                    If(gblPF_DEBUG_EVAL,
                        With(
                            LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNode,
                
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                " fCE_400(): san: " & theCurrentNode.inactiveColorMoveRecord.san &
                                " pacn: " & theCurrentNode.inactiveColorMoveRecord.pacn &
                                " centipawn: " & theCurrentNode.postMoveEvalRecord.centipawn
                            })
                        )
                    )
                );
                
                If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & " fCE_400(): exiting"})
                )
                
    fCE_500(pNodeID As Number):
        pNodeID:
            Default: =100
        ThisProperty:
            Default: |+
                =
                If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                        " comChessEngineFunctions.fCE_500(): entered pNodeID: " & pNodeID
                    })
                );
                
                With(
                    LookUp(colPF_DYNAMIC_DATA, dataName=DYNAMIC_DATA_PF_NAME) As theData,
                
                    With(
                        LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNode,
                
                        If(gblPF_DEBUG_EVAL,
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                " fCE_500(): san: " & theCurrentNode.inactiveColorMoveRecord.san &
                                " pacn: " & theCurrentNode.inactiveColorMoveRecord.pacn &
                                " move color: " & UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN) &
                                " captureSquareOccupier: " & theCurrentNode.inactiveColorMoveRecord.captureSquareOccupier
                            })
                        );
                
                        Patch(colPF_MOVE_TREE, First(Filter(colPF_MOVE_TREE, nodeID=pNodeID)), {
                            postMoveEvalRecord: 
                                Patch(EVAL_RECORD_PF, {
                                    heuristic11:
                                        With(
                                            {
                                                materialDelta:
                                                    Sum(
                                                        ForAll(
                                                            Split(UDF_FEN_TO_PIECE_PLACEMENT(theCurrentNode.postMoveFEN), "") As thePiece,
                
                                                            UDF_getPieceCentipawnMaterialValue(thePiece.Value, "QRBNPqrbnp")
                                                        ),
                                                        Value
                                                    ) -
                                                    Sum(
                                                        ForAll(
                                                            Split(UDF_FEN_TO_PIECE_PLACEMENT(theCurrentNode.preMoveFEN), "") As thePiece,
                
                                                            UDF_getPieceCentipawnMaterialValue(thePiece.Value, "QRBNPqrbnp")
                                                        ),
                                                        Value
                                                    ),
                                                materialSource:
                                                    UDF_getPieceCentipawnMaterialValue(
                                                        theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier,
                                                        ALL_PIECES
                                                    ),
                                                materialCapture: 
                                                    UDF_getPieceCentipawnMaterialValue(
                                                        theCurrentNode.inactiveColorMoveRecord.captureSquareOccupier,
                                                        ALL_PIECES
                                                    ),
                                                targetSqAttacked:
                                                    UDF_isSqNumAttacked(
                                                        theCurrentNode.postMoveBoard,
                                                        theCurrentNode.inactiveColorMoveRecord.targetSquareNum,
                                                        UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.postMoveFEN)
                                                    )
                                            } As localVars,
                
                                            If(!localVars.targetSqAttacked || (Abs(localVars.materialSource)<Abs(localVars.materialCapture)),
                                                // THEN
                                                localVars.materialDelta,
                
                                                // ELSE - discourage the move
                                                If(UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)=WHITE,-25,25)
                                            )
                                        ),
                                    heuristic12:
                                        // no capture - but moving an attacked piece to a unattacked square needs a small bonus
                                        With(
                                            {
                                                materialDelta:
                                                    Sum(
                                                        ForAll(
                                                            Split(UDF_FEN_TO_PIECE_PLACEMENT(theCurrentNode.postMoveFEN), "") As thePiece,
                
                                                            UDF_getPieceCentipawnMaterialValue(thePiece.Value, "QRBNPqrbnp")
                                                        ),
                                                        Value
                                                    ) -
                                                    Sum(
                                                        ForAll(
                                                            Split(UDF_FEN_TO_PIECE_PLACEMENT(theCurrentNode.preMoveFEN), "") As thePiece,
                
                                                            UDF_getPieceCentipawnMaterialValue(thePiece.Value, "QRBNPqrbnp")
                                                        ),
                                                        Value
                                                    ),
                                                materialSource:
                                                    UDF_getPieceCentipawnMaterialValue(
                                                        theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier,
                                                        ALL_PIECES
                                                    ),
                                                sourceSqAttacked:
                                                    UDF_isSqNumAttacked(
                                                        theCurrentNode.preMoveBoard,
                                                        theCurrentNode.inactiveColorMoveRecord.sourceSquareNum,
                                                        UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.postMoveFEN)
                                                    ),
                                                targetSqAttacked:
                                                    UDF_isSqNumAttacked(
                                                        theCurrentNode.postMoveBoard,
                                                        theCurrentNode.inactiveColorMoveRecord.targetSquareNum,
                                                        UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.postMoveFEN)
                                                    )
                                            } As localVars,
                
                                            If(localVars.sourceSqAttacked && !localVars.targetSqAttacked && localVars.materialDelta=0,
                                                // THEN
                                                If(UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)=WHITE,RandBetween(50,75),RandBetween(-75,-50)),
                
                                                // ELSE
                                                0
                                            )
                                        ),
                
                                    heuristic16:
                                        If(!(comChessEngineFunctions.fME_getGamePhase(theCurrentNode.preMoveFEN)=GAME_PHASE_END),
                                            // THEN - not in the END GAME
                                            0,
                
                                            // ELSE - do END GAME analysis
                                            With(
                                                {
                                                    totalWhiteBonus:
                                                        Sum(
                                                            // Sum: Push Pawns forward - push the pawns forward (until we have enough Qs) - is this a pawn move ?
                                                            If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "P" && UDF_countPiecesOnBoard(theCurrentNode.preMoveBoard, "Q")<3,
                                                                // THEN - push the pawn and bump up the promotion to a Q
                                                                If(
                                                                    (IsBlank(theCurrentNode.inactiveColorMoveRecord.promoteTo) || theCurrentNode.inactiveColorMoveRecord.promoteTo in "Q") &&
                                                                    !UDF_isSqNumAttacked(
                                                                        theCurrentNode.postMoveBoard,
                                                                        theCurrentNode.inactiveColorMoveRecord.targetSquareNum,
                                                                        UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.postMoveFEN)
                                                                    ),
                                                                    // THEN
                                                                    UDF_getRankFromSqName(theCurrentNode.inactiveColorMoveRecord.targetSquareName) * RandBetween(8,13),
                
                                                                    // ELSE
                                                                    0
                                                                ),
                                                                // ELSE
                                                                0
                                                            ),
                
                                                            // Sum: trapping the king
                                                            With(
                                                                {
                                                                    sqNum:
                                                                        UDF_SearchBoardForPiece(theCurrentNode.preMoveBoard, UDF_getICPieceABBR(theCurrentNode.preMoveFEN, "k"))
                                                                } As theKing,
                
                                                                If(gblPF_DEBUG_EVAL,
                                                                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                        " fCE_500(): DEBUG heuristic16 theKing.sqNum: " & UDF_sqNumToSqName(theKing.sqNum) & "(" & theKing.sqNum & ")" 
                                                                    });
                                                                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                        " current kingDangerBoard: " & theCurrentNode.postMoveActiveKingDangerBoard 
                                                                    });
                                                                );
                
                                                                With(
                                                                    {
                                                                        adjSquaresSet:  UDF_createSetOfSqNames(UDF_sqNumToAdjacentSqNamesSet(theKing.sqNum) & " " &  UDF_sqNumToSqName(theKing.sqNum)),
                                                                        noKingPreMoveBoard: UDF_setBitAtSqNum(theCurrentNode.preMoveBoard,EMPTY_FILLER_ABBR,theKing.sqNum),
                                                                        noKingPostMoveBoard:    UDF_setBitAtSqNum(theCurrentNode.postMoveBoard,EMPTY_FILLER_ABBR,theKing.sqNum),
                                                                        // remove the moving piece so that we can determine if we can move to an adjacent protected square
                                                                        noKingNoPiecePostMoveBoard:
                                                                            UDF_setBitAtSqNum(
                                                                                UDF_setBitAtSqNum(theCurrentNode.postMoveBoard,
                                                                                    EMPTY_FILLER_ABBR,
                                                                                    theCurrentNode.inactiveColorMoveRecord.targetSquareNum
                                                                                ),
                                                                                EMPTY_FILLER_ABBR,
                                                                                theKing.sqNum
                                                                            )
                                                                    } As nextToKing,
                
                                                                    If(gblPF_DEBUG_EVAL,
                                                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                            " fCE_500(): DEBUG heuristic16 theKing.sqNum: " & UDF_sqNumToSqName(theKing.sqNum) & "(" & theKing.sqNum & ")" &
                                                                            " adjSquaresSet: " & nextToKing.adjSquaresSet
                                                                        });
                                                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                            " premove no king board: " & nextToKing.noKingPreMoveBoard
                                                                        });
                                                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                            " postmove no king board: " & nextToKing.noKingPostMoveBoard
                                                                        });
                                                                    );
                
                                                                    With(
                                                                        {
                                                                            numAdjSquaresAttackedPreMove:
                                                                                UDF_getSetSize(
                                                                                    UDF_createSetOfSqNames(
                                                                                        Concat(
                                                                                            ForAll(
                                                                                                Split(nextToKing.adjSquaresSet, " ") As adjSqName,
                
                                                                                                If(gblPF_DEBUG_EVAL,
                                                                                                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                                                        " fCE_500(): DEBUG heuristic16 adjSqName.Value: " & adjSqName.Value &
                                                                                                        " premove AttackerSet: " &
                                                                                                            UDF_getAttackerSqNamesSet(
                                                                                                                nextToKing.noKingPreMoveBoard,
                                                                                                                UDF_sqNameToSqNum(adjSqName.Value),
                                                                                                                UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)
                                                                                                            )
                                                                                                    })
                                                                                                );
                
                                                                                                If(
                                                                                                    UDF_getSetSize(
                                                                                                        UDF_getAttackerSqNamesSet(
                                                                                                            nextToKing.noKingPreMoveBoard,
                                                                                                            UDF_sqNameToSqNum(adjSqName.Value),
                                                                                                            UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)
                                                                                                        )
                                                                                                    )>0,
                                                                                                    adjSqName.Value, ""
                                                                                                )
                                                                                            ), Value, " "
                                                                                        )
                                                                                    )
                                                                                ),
                                                                            numAdjSquaresAttackedPostMove:
                                                                                UDF_getSetSize(
                                                                                    UDF_createSetOfSqNames(
                                                                                        Concat(
                                                                                            ForAll(
                                                                                                Split(nextToKing.adjSquaresSet, " ") As adjSqName,
                
                                                                                                If(gblPF_DEBUG_EVAL,
                                                                                                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                                                        " fCE_500(): DEBUG heuristic16 adjSqName.Value: " & adjSqName.Value &
                                                                                                        " postmove AttackerSet: " &
                                                                                                            UDF_getAttackerSqNamesSet(
                                                                                                                nextToKing.noKingPostMoveBoard,
                                                                                                                UDF_sqNameToSqNum(adjSqName.Value),
                                                                                                                UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)
                                                                                                            )
                                                                                                    })
                                                                                                );
                
                                                                                                If(
                                                                                                    UDF_getSetSize(
                                                                                                        UDF_getAttackerSqNamesSet(
                                                                                                            nextToKing.noKingPostMoveBoard,
                                                                                                            UDF_sqNameToSqNum(adjSqName.Value),
                                                                                                            UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)
                                                                                                        )
                                                                                                    )>0,
                                                                                                    adjSqName.Value, ""
                                                                                                )
                                                                                            ), Value, " "
                                                                                        )
                                                                                    )
                                                                                ),
                                                                            numTargetSquareAttackedPostMove:
                                                                                If(theCurrentNode.inactiveColorMoveRecord.targetSquareName in nextToKing.adjSquaresSet,
                                                                                    // THEN
                                                                                    UDF_getSetSize(
                                                                                        UDF_getAttackerSqNamesSet(
                                                                                            nextToKing.noKingNoPiecePostMoveBoard,
                                                                                            theCurrentNode.inactiveColorMoveRecord.targetSquareNum,
                                                                                            UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)
                                                                                        )
                                                                                    ),
                
                                                                                    // ELSE
                                                                                    0
                                                                                )
                                                                        } As attackData,
                
                                                                        If(gblPF_DEBUG_EVAL,
                                                                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                                " fCE_500(): DEBUG heuristic16 theKing.sqNum: " & UDF_sqNumToSqName(theKing.sqNum) & "(" & theKing.sqNum & ")" &
                                                                                " numAdjSquaresAttackedPreMove: " & attackData.numAdjSquaresAttackedPreMove &
                                                                                " numAdjSquaresAttackedPostMove: " & attackData.numAdjSquaresAttackedPostMove &
                                                                                " numTargetSquareAttackedPostMove: " & attackData.numTargetSquareAttackedPostMove
                                                                            })
                                                                        );
                
                                                                        With(
                                                                            {
                                                                                preMove:
                                                                                    If(
                                                                                        UDF_countSqNumAttacks(
                                                                                            nextToKing.noKingPreMoveBoard,
                                                                                            theKing.sqNum,
                                                                                            UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)
                                                                                        )>0,
                                                                                        true,false
                                                                                    ),
                                                                                postMove:
                                                                                    If(
                                                                                        UDF_countSqNumAttacks(
                                                                                            nextToKing.noKingPostMoveBoard,
                                                                                            theKing.sqNum,
                                                                                            UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)
                                                                                        )>0,
                                                                                        true,false
                                                                                    )
                                                                            } As theKingChecked,
                
                                                                            If(gblPF_DEBUG_EVAL,
                                                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                                    " fCE_500(): DEBUG heuristic16 preMove" & 
                                                                                    " # of adj Squares: " & UDF_getSetSize(nextToKing.adjSquaresSet) &
                                                                                    " theKingChecked.preMove: " & theKingChecked.preMove &
                                                                                    " theKingChecked.postMove: " & theKingChecked.postMove &
                                                                                    " numAdjSquaresAttackedPreMove: " & attackData.numAdjSquaresAttackedPreMove &
                                                                                    " numAdjSquaresAttackedPostMove: " & attackData.numAdjSquaresAttackedPostMove
                                                                                })
                                                                            );
                                                                            If((UDF_getSetSize(nextToKing.adjSquaresSet) - attackData.numAdjSquaresAttackedPostMove)=1 && !theKingChecked.postMove,
                                                                                // THEN - this move would cause a stalemate
                                                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                                    " fCE_500(): DEBUG heuristic16 postmove stalemate detected "
                                                                                });
                                                                                -1000,  // discourage the move
                
                                                                                // ELSE
                                                                                If(
                                                                                    theCurrentNode.inactiveColorMoveRecord.targetSquareName in nextToKing.adjSquaresSet &&
                                                                                    attackData.numTargetSquareAttackedPostMove=0,
                                                                                    // THEN - king can reach us and we are not protected - discourage move
                                                                                    -50,
                
                                                                                    // ELSE
                                                                                    If(attackData.numAdjSquaresAttackedPostMove=UDF_getSetSize(nextToKing.adjSquaresSet),
                                                                                        // THEN - checkmate !
                                                                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                                            " checkmate FEN: " & theCurrentNode.preMoveFEN
                                                                                        });
                                                                                        10000, // strongly encourage the move
                                                                                        // ELSE - encourage the move if warranted
                                                                                        (attackData.numAdjSquaresAttackedPostMove - attackData.numAdjSquaresAttackedPreMove) * 21
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            ),
                
                                                            // Sum: TBD...
                                                            0
                                                        )
                                                } As totalBonus,
                
                                                If(UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)=WHITE,totalBonus.totalWhiteBonus,-totalBonus.totalWhiteBonus)
                                            )
                                        ),
                
                                    heuristic18:
                                        // add some order
                                        If(UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)=WHITE,
                                            // THEN
                                            Switch(comChessEngineFunctions.fME_getGamePhase(theCurrentNode.preMoveFEN),
                                                GAME_PHASE_OPENING,
                                                    If(
                                                        theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "NP" ||
                                                        IsMatch(theCurrentNode.inactiveColorMoveRecord.san, "O-O", MatchOptions.BeginsWith),
                                                            // THEN
                                                            RandBetween(-5,15),
                                                            
                                                            // ELSE
                                                            0
                                                    ),
                                                GAME_PHASE_MIDDLE,
                                                    If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "QBNP", RandBetween(-5,15), 0),
                                                If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "QR", RandBetween(-5,10), 0)
                                            ),
                
                                            // ELSE
                                            Switch(comChessEngineFunctions.fME_getGamePhase(theCurrentNode.preMoveFEN),
                                                GAME_PHASE_OPENING,
                                                    If(
                                                        theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "NP" ||
                                                        IsMatch(theCurrentNode.inactiveColorMoveRecord.san, "O-O", MatchOptions.BeginsWith),
                                                            // THEN
                                                            RandBetween(-15,-5),
                                                            
                                                            // ELSE
                                                            0
                                                    ),
                                                GAME_PHASE_MIDDLE,
                                                    If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "QBNP", RandBetween(-15,5), 0),
                                                If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "QR", RandBetween(-10,5), 0)
                                            )
                                        ),
                                    heuristic19:
                                        RandBetween(-8,8)
                
                                })
                        });
                
                        UpdateIf(colPF_MOVE_TREE, nodeID=pNodeID, {
                            postMoveEvalRecord: 
                                Patch(LookUp(colPF_MOVE_TREE, nodeID=pNodeID).postMoveEvalRecord, {
                                    centipawn:
                                        With(
                                            LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNodeUpdated,
                                            
                                            If(gblPF_DEBUG_EVAL,
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic11: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic11
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic12: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic12
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic16: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic16
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic18: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic18
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic19 the God of Randomness BONUS/PENALTY sub-total: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic19
                                                })
                                            );
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic11 +
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic12 +
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic16 +
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic18 +
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic19
                                        )
                                })
                        })
                    );
                
                    If(gblPF_DEBUG_EVAL,
                        With(
                            LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNode,
                
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                " fCE_500(): san: " & theCurrentNode.inactiveColorMoveRecord.san &
                                " pacn: " & theCurrentNode.inactiveColorMoveRecord.pacn &
                                " centipawn: " & theCurrentNode.postMoveEvalRecord.centipawn
                            })
                        )
                    )
                );
                
                If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & " fCE_500(): exiting"})
                )
                
    fCE_600(pNodeID As Number):
        pNodeID:
            Default: =100
        ThisProperty:
            Default: |+
                =
                If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                        " comChessEngineFunctions.fCE_600(): entered pNodeID: " & pNodeID
                    })
                );
                
                With(
                    LookUp(colPF_DYNAMIC_DATA, dataName=DYNAMIC_DATA_PF_NAME) As theData,
                
                    With(
                        LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNode,
                
                        If(gblPF_DEBUG_EVAL,
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                " fCE_600(): san: " & theCurrentNode.inactiveColorMoveRecord.san &
                                " pacn: " & theCurrentNode.inactiveColorMoveRecord.pacn &
                                " move color: " & UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN) &
                                " captureSquareOccupier: " & theCurrentNode.inactiveColorMoveRecord.captureSquareOccupier
                            })
                        );
                
                        Patch(colPF_MOVE_TREE, First(Filter(colPF_MOVE_TREE, nodeID=pNodeID)), {
                            postMoveEvalRecord: 
                                Patch(EVAL_RECORD_PF, {
                                    heuristic11:
                                        With(
                                            {
                                                materialDelta:
                                                    Sum(
                                                        ForAll(
                                                            Split(UDF_FEN_TO_PIECE_PLACEMENT(theCurrentNode.postMoveFEN), "") As thePiece,
                
                                                            UDF_getPieceCentipawnMaterialValue(thePiece.Value, "QRBNPqrbnp")
                                                        ),
                                                        Value
                                                    ) -
                                                    Sum(
                                                        ForAll(
                                                            Split(UDF_FEN_TO_PIECE_PLACEMENT(theCurrentNode.preMoveFEN), "") As thePiece,
                
                                                            UDF_getPieceCentipawnMaterialValue(thePiece.Value, "QRBNPqrbnp")
                                                        ),
                                                        Value
                                                    ),
                                                materialSource:
                                                    UDF_getPieceCentipawnMaterialValue(
                                                        theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier,
                                                        ALL_PIECES
                                                    ),
                                                materialCapture: 
                                                    UDF_getPieceCentipawnMaterialValue(
                                                        theCurrentNode.inactiveColorMoveRecord.captureSquareOccupier,
                                                        ALL_PIECES
                                                    ),
                                                targetSqAttacked:
                                                    UDF_isSqNumAttacked(
                                                        theCurrentNode.postMoveBoard,
                                                        theCurrentNode.inactiveColorMoveRecord.targetSquareNum,
                                                        UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.postMoveFEN)
                                                    )
                                            } As localVars,
                
                                            If(!localVars.targetSqAttacked || (Abs(localVars.materialSource)<=Abs(localVars.materialCapture)),
                                                // THEN
                                                localVars.materialDelta,
                
                                                // ELSE - discourage the move
                                                If(UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)=WHITE,-25,25)
                                            )
                                        ),
                                    heuristic12:
                                        // no capture - but moving an attacked piece to a unattacked square needs a small bonus
                                        With(
                                            {
                                                materialDelta:
                                                    Sum(
                                                        ForAll(
                                                            Split(UDF_FEN_TO_PIECE_PLACEMENT(theCurrentNode.postMoveFEN), "") As thePiece,
                
                                                            UDF_getPieceCentipawnMaterialValue(thePiece.Value, "QRBNPqrbnp")
                                                        ),
                                                        Value
                                                    ) -
                                                    Sum(
                                                        ForAll(
                                                            Split(UDF_FEN_TO_PIECE_PLACEMENT(theCurrentNode.preMoveFEN), "") As thePiece,
                
                                                            UDF_getPieceCentipawnMaterialValue(thePiece.Value, "QRBNPqrbnp")
                                                        ),
                                                        Value
                                                    ),
                                                materialSource:
                                                    UDF_getPieceCentipawnMaterialValue(
                                                        theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier,
                                                        ALL_PIECES
                                                    ),
                                                sourceSqAttacked:
                                                    UDF_isSqNumAttacked(
                                                        theCurrentNode.preMoveBoard,
                                                        theCurrentNode.inactiveColorMoveRecord.sourceSquareNum,
                                                        UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.postMoveFEN)
                                                    ),
                                                sourceSqProtected:
                                                    UDF_isSqNumAttacked(
                                                        UDF_setBitAtSqNum(
                                                            theCurrentNode.preMoveBoard,
                                                            EMPTY_FILLER_ABBR,
                                                            theCurrentNode.inactiveColorMoveRecord.sourceSquareNum
                                                        ),
                                                        theCurrentNode.inactiveColorMoveRecord.sourceSquareNum,
                                                        UDF_FEN_TO_INACTIVE_COLOR(theCurrentNode.postMoveFEN)
                                                    ),
                                                // materialSourceAttacker:
                                                targetSqAttacked:
                                                    UDF_isSqNumAttacked(
                                                        theCurrentNode.postMoveBoard,
                                                        theCurrentNode.inactiveColorMoveRecord.targetSquareNum,
                                                        UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.postMoveFEN)
                                                    )
                                            } As localVars,
                
                                            // If(localVars.sourceSqAttacked && (!localVars.sourceSqProtected)
                                            If(localVars.sourceSqAttacked && (!localVars.targetSqAttacked) && localVars.materialDelta=0,
                                                // THEN
                                                //If(UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)=WHITE,localVars.materialSource,-localVars.materialSource),
                                                localVars.materialSource,
                
                                                // ELSE
                                                0
                                            )
                                        ),
                
                                    heuristic15:
                                        If(!(comChessEngineFunctions.fME_getGamePhase(theCurrentNode.preMoveFEN)=GAME_PHASE_OPENING),
                                            // THEN
                                            With(
                                                {
                                                    gettingForkedPieces:   If(UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)=WHITE,BLACK_PIECES,WHITE_PIECES),
                                                    forkingPieces:         If(UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)=WHITE,WHITE_PIECES,BLACK_PIECES)
                                                } As forkPieces,
                
                                                With(
                                                    {
                                                        gettingForkedSet:   UDF_occupiedSqNamesSet(theCurrentNode.postMoveBoard, forkPieces.gettingForkedPieces),
                                                        forkingSet:         UDF_occupiedSqNamesSet(theCurrentNode.postMoveBoard, forkPieces.forkingPieces)
                                                    } As forkSets,
                                                    
                                                    With(
                                                        {
                                                            targetTargetsSet:
                                                                // get only the eligibleSqName column
                                                                UDF_createSetOfSqNames(
                                                                    Concat(
                                                                        ShowColumns(
                                                                            Filter(colPF_LEGAL_MOVES,
                                                                                sqNum=theCurrentNode.inactiveColorMoveRecord.targetSquareNum,
                                                                                pieceUpper=Upper(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier),
                                                                                eligibleSqName in forkSets.gettingForkedSet,
                                                                                UDF_getSetSize(  
                                                                                    UDF_getSetIntersection(
                                                                                        slideOvers,
                                                                                        UDF_getSetUnion(forkSets.forkingSet,forkSets.gettingForkedSet)
                                                                                    )
                                                                                )=0
                                                                            ), eligibleSqName
                                                                        ), eligibleSqName, " "
                                                                    )
                                                                ),
                                                            targetIsAttacked:
                                                                UDF_isSqNumAttacked(
                                                                    theCurrentNode.postMoveBoard, 
                                                                    theCurrentNode.inactiveColorMoveRecord.targetSquareNum,
                                                                    UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.postMoveFEN)
                                                                )
                                                        } As targetData,
                
                                                        If(gblPF_DEBUG_EVAL,
                                                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                " fCE_600(): DEBUG heuristic15" & 
                                                                " gettingForkedSet: " & forkSets.gettingForkedSet &
                                                                " forkingSet: " & forkSets.forkingSet &
                                                                " targetTargetsSet: " & targetData.targetTargetsSet &
                                                                " target IsAttacked?: " & targetData.targetIsAttacked
                                                            })
                                                        );
                                                        If(targetData.targetIsAttacked,
                                                            // THEN
                                                            0,
                
                                                            // ELSE
                                                            With(
                                                                {
                                                                    attackedTargetTargetsCount:
                                                                        Sum(
                                                                            ForAll(
                                                                                Split(targetData.targetTargetsSet, " ") As theTargets,
                
                                                                                If(
                                                                                    UDF_isSqNumAttacked(
                                                                                        theCurrentNode.postMoveBoard,
                                                                                        UDF_sqNameToSqNum(theTargets.Value),
                                                                                        UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.postMoveFEN)
                                                                                    ),
                                                                                    // THEN
                                                                                    1,
                
                                                                                    // ELSE
                                                                                    0
                                                                                )
                                                                            ), Value
                                                                        )
                                                                } As counts,
                
                                                                If(gblPF_DEBUG_EVAL,
                                                                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                        " fCE_600(): DEBUG heuristic15" & 
                                                                        " attackedTargetTargetsCount: " & counts.attackedTargetTargetsCount
                                                                    })
                                                                );
                
                                                                If(counts.attackedTargetTargetsCount>=UDF_getSetSize(targetData.targetTargetsSet),
                                                                    // THEN
                                                                    0,
                
                                                                    // ELSE
                                                                    If(UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)=WHITE,55,-55)
                                                                )
                                                            )
                                                        )
                                                    )
                                                )
                                            ),
                
                                            // ELSE
                                            0
                                        ),
                
                                    heuristic16:
                                        If(!(comChessEngineFunctions.fME_getGamePhase(theCurrentNode.preMoveFEN)=GAME_PHASE_END),
                                            // THEN - not in the END GAME
                                            0,
                
                                            // ELSE - do END GAME analysis
                                            With(
                                                {
                                                    totalBonus:
                                                        Sum(
                                                            // Sum: Push Pawns forward - push the pawns forward (until we have enough Qs) - is this a pawn move ?
                                                            If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "P" && UDF_countPiecesOnBoard(theCurrentNode.preMoveBoard, "Q")<3,
                                                                // THEN - push the pawn and bump up the promotion to a Q
                                                                If(
                                                                    (IsBlank(theCurrentNode.inactiveColorMoveRecord.promoteTo) || theCurrentNode.inactiveColorMoveRecord.promoteTo in "Q") &&
                                                                    !UDF_isSqNumAttacked(
                                                                        theCurrentNode.postMoveBoard,
                                                                        theCurrentNode.inactiveColorMoveRecord.targetSquareNum,
                                                                        UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.postMoveFEN)
                                                                    ),
                                                                    // THEN
                                                                    If(UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)=WHITE,
                                                                        UDF_getRankFromSqName(theCurrentNode.inactiveColorMoveRecord.targetSquareName),
                                                                        8 - UDF_getRankFromSqName(theCurrentNode.inactiveColorMoveRecord.targetSquareName)
                                                                     ) * RandBetween(8,21),
                
                                                                    // ELSE
                                                                    0
                                                                ),
                                                                // ELSE
                                                                0
                                                            ),
                
                                                            // Sum: trapping the king
                                                            With(
                                                                {
                                                                    sqNum:
                                                                        UDF_SearchBoardForPiece(theCurrentNode.preMoveBoard, UDF_getICPieceABBR(theCurrentNode.preMoveFEN, "k"))
                                                                } As theKing,
                
                                                                If(gblPF_DEBUG_EVAL,
                                                                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                        " fCE_600(): DEBUG heuristic16 theKing.sqNum: " & UDF_sqNumToSqName(theKing.sqNum) & "(" & theKing.sqNum & ")" 
                                                                    });
                                                                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                        " current kingDangerBoard: " & theCurrentNode.postMoveActiveKingDangerBoard 
                                                                    });
                                                                );
                
                                                                With(
                                                                    {
                                                                        adjSquaresSet:  UDF_createSetOfSqNames(UDF_sqNumToAdjacentSqNamesSet(theKing.sqNum) & " " &  UDF_sqNumToSqName(theKing.sqNum)),
                                                                        noKingPreMoveBoard: UDF_setBitAtSqNum(theCurrentNode.preMoveBoard,EMPTY_FILLER_ABBR,theKing.sqNum),
                                                                        noKingPostMoveBoard:    UDF_setBitAtSqNum(theCurrentNode.postMoveBoard,EMPTY_FILLER_ABBR,theKing.sqNum),
                                                                        // remove the moving piece so that we can determine if we can move to an adjacent protected square
                                                                        noKingNoPiecePostMoveBoard:
                                                                            UDF_setBitAtSqNum(
                                                                                UDF_setBitAtSqNum(theCurrentNode.postMoveBoard,
                                                                                    EMPTY_FILLER_ABBR,
                                                                                    theCurrentNode.inactiveColorMoveRecord.targetSquareNum
                                                                                ),
                                                                                EMPTY_FILLER_ABBR,
                                                                                theKing.sqNum
                                                                            )
                                                                    } As nextToKing,
                
                                                                    If(gblPF_DEBUG_EVAL,
                                                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                            " fCE_600(): DEBUG heuristic16 theKing.sqNum: " & UDF_sqNumToSqName(theKing.sqNum) & "(" & theKing.sqNum & ")" &
                                                                            " adjSquaresSet: " & nextToKing.adjSquaresSet
                                                                        });
                                                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                            " premove no king board: " & nextToKing.noKingPreMoveBoard
                                                                        });
                                                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                            " postmove no king board: " & nextToKing.noKingPostMoveBoard
                                                                        });
                                                                    );
                
                                                                    With(
                                                                        {
                                                                            numAdjSquaresAttackedPreMove:
                                                                                UDF_getSetSize(
                                                                                    UDF_createSetOfSqNames(
                                                                                        Concat(
                                                                                            ForAll(
                                                                                                Split(nextToKing.adjSquaresSet, " ") As adjSqName,
                
                                                                                                If(gblPF_DEBUG_EVAL,
                                                                                                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                                                        " fCE_600(): DEBUG heuristic16 adjSqName.Value: " & adjSqName.Value &
                                                                                                        " premove AttackerSet: " &
                                                                                                            UDF_getAttackerSqNamesSet(
                                                                                                                nextToKing.noKingPreMoveBoard,
                                                                                                                UDF_sqNameToSqNum(adjSqName.Value),
                                                                                                                UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)
                                                                                                            )
                                                                                                    })
                                                                                                );
                
                                                                                                If(
                                                                                                    UDF_getSetSize(
                                                                                                        UDF_getAttackerSqNamesSet(
                                                                                                            nextToKing.noKingPreMoveBoard,
                                                                                                            UDF_sqNameToSqNum(adjSqName.Value),
                                                                                                            UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)
                                                                                                        )
                                                                                                    )>0,
                                                                                                    adjSqName.Value, ""
                                                                                                )
                                                                                            ), Value, " "
                                                                                        )
                                                                                    )
                                                                                ),
                                                                            numAdjSquaresAttackedPostMove:
                                                                                UDF_getSetSize(
                                                                                    UDF_createSetOfSqNames(
                                                                                        Concat(
                                                                                            ForAll(
                                                                                                Split(nextToKing.adjSquaresSet, " ") As adjSqName,
                
                                                                                                If(gblPF_DEBUG_EVAL,
                                                                                                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                                                        " fCE_600(): DEBUG heuristic16 adjSqName.Value: " & adjSqName.Value &
                                                                                                        " postmove AttackerSet: " &
                                                                                                            UDF_getAttackerSqNamesSet(
                                                                                                                nextToKing.noKingPostMoveBoard,
                                                                                                                UDF_sqNameToSqNum(adjSqName.Value),
                                                                                                                UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)
                                                                                                            )
                                                                                                    })
                                                                                                );
                
                                                                                                If(
                                                                                                    UDF_getSetSize(
                                                                                                        UDF_getAttackerSqNamesSet(
                                                                                                            nextToKing.noKingPostMoveBoard,
                                                                                                            UDF_sqNameToSqNum(adjSqName.Value),
                                                                                                            UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)
                                                                                                        )
                                                                                                    )>0,
                                                                                                    adjSqName.Value, ""
                                                                                                )
                                                                                            ), Value, " "
                                                                                        )
                                                                                    )
                                                                                ),
                                                                            numTargetSquareAttackedPostMove:
                                                                                If(theCurrentNode.inactiveColorMoveRecord.targetSquareName in nextToKing.adjSquaresSet,
                                                                                    // THEN
                                                                                    UDF_getSetSize(
                                                                                        UDF_getAttackerSqNamesSet(
                                                                                            nextToKing.noKingNoPiecePostMoveBoard,
                                                                                            theCurrentNode.inactiveColorMoveRecord.targetSquareNum,
                                                                                            UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)
                                                                                        )
                                                                                    ),
                
                                                                                    // ELSE
                                                                                    0
                                                                                )
                                                                        } As attackData,
                
                                                                        If(gblPF_DEBUG_EVAL,
                                                                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                                " fCE_600(): DEBUG heuristic16 theKing.sqNum: " & UDF_sqNumToSqName(theKing.sqNum) & "(" & theKing.sqNum & ")" &
                                                                                " numAdjSquaresAttackedPreMove: " & attackData.numAdjSquaresAttackedPreMove &
                                                                                " numAdjSquaresAttackedPostMove: " & attackData.numAdjSquaresAttackedPostMove &
                                                                                " numTargetSquareAttackedPostMove: " & attackData.numTargetSquareAttackedPostMove
                                                                            })
                                                                        );
                
                                                                        With(
                                                                            {
                                                                                preMove:
                                                                                    If(
                                                                                        UDF_countSqNumAttacks(
                                                                                            nextToKing.noKingPreMoveBoard,
                                                                                            theKing.sqNum,
                                                                                            UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)
                                                                                        )>0,
                                                                                        true,false
                                                                                    ),
                                                                                postMove:
                                                                                    If(
                                                                                        UDF_countSqNumAttacks(
                                                                                            nextToKing.noKingPostMoveBoard,
                                                                                            theKing.sqNum,
                                                                                            UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)
                                                                                        )>0,
                                                                                        true,false
                                                                                    )
                                                                            } As theKingChecked,
                
                                                                            If(gblPF_DEBUG_EVAL,
                                                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                                    " fCE_600(): DEBUG heuristic16 preMove" & 
                                                                                    " # of adj Squares: " & UDF_getSetSize(nextToKing.adjSquaresSet) &
                                                                                    " theKingChecked.preMove: " & theKingChecked.preMove &
                                                                                    " theKingChecked.postMove: " & theKingChecked.postMove &
                                                                                    " numAdjSquaresAttackedPreMove: " & attackData.numAdjSquaresAttackedPreMove &
                                                                                    " numAdjSquaresAttackedPostMove: " & attackData.numAdjSquaresAttackedPostMove
                                                                                })
                                                                            );
                                                                            If((UDF_getSetSize(nextToKing.adjSquaresSet) - attackData.numAdjSquaresAttackedPostMove)=1 && !theKingChecked.postMove,
                                                                                // THEN - this move would cause a stalemate
                                                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                                    " fCE_600(): DEBUG heuristic16 postmove stalemate detected "
                                                                                });
                                                                                -1000,  // discourage the move
                
                                                                                // ELSE
                                                                                If(
                                                                                    theCurrentNode.inactiveColorMoveRecord.targetSquareName in nextToKing.adjSquaresSet &&
                                                                                    attackData.numTargetSquareAttackedPostMove=0,
                                                                                    // THEN - king can reach us and we are not protected - discourage move
                                                                                    -50,
                
                                                                                    // ELSE
                                                                                    If(attackData.numAdjSquaresAttackedPostMove=UDF_getSetSize(nextToKing.adjSquaresSet),
                                                                                        // THEN - checkmate !
                                                                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                                                                            " checkmate FEN: " & theCurrentNode.preMoveFEN
                                                                                        });
                                                                                        10000, // strongly encourage the move
                                                                                        
                                                                                        // ELSE - encourage the move if warranted - early in game reduce impact
                                                                                        If(attackData.numAdjSquaresAttackedPostMove>attackData.numAdjSquaresAttackedPreMove,
                                                                                            // THEN
                                                                                            (attackData.numAdjSquaresAttackedPostMove - attackData.numAdjSquaresAttackedPreMove) * 21,
                
                                                                                            // ELSE
                                                                                            0 
                                                                                        )
                                                                                    )
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                )
                                                            ),
                
                                                            // Sum: TBD...
                                                            0
                                                        )
                                                } As totalBonus,
                
                                                If(UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)=WHITE,totalBonus.totalBonus,-totalBonus.totalBonus)
                                            )
                                        ),
                
                                    heuristic18:
                                        // add some order
                                        If(UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)=WHITE,
                                            // THEN
                                            Switch(comChessEngineFunctions.fME_getGamePhase(theCurrentNode.preMoveFEN),
                                                GAME_PHASE_OPENING,
                                                    Switch(true,
                                                        IsMatch(theCurrentNode.inactiveColorMoveRecord.san, "O-O", MatchOptions.BeginsWith),
                                                            RandBetween(10,25),
                                                        theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "BNP" && Text(theCurrentNode.inactiveColorMoveRecord.moveDirection) in "128",
                                                            RandBetween(0,15),
                                                            
                                                        // default
                                                            0
                                                    ),
                                                GAME_PHASE_MIDDLE,
                                                    Switch(true,
                                                        IsMatch(theCurrentNode.inactiveColorMoveRecord.san, "O-O", MatchOptions.BeginsWith),
                                                            RandBetween(10,25),
                                                        theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "QBNP", 
                                                            RandBetween(0,15),
                
                                                        // default
                                                        0
                                                    ),
                
                                                // default
                                                0
                                            ),
                
                                            // ELSE
                                            Switch(comChessEngineFunctions.fME_getGamePhase(theCurrentNode.preMoveFEN),
                                                GAME_PHASE_OPENING,
                                                    Switch(true,
                                                        IsMatch(theCurrentNode.inactiveColorMoveRecord.san, "O-O", MatchOptions.BeginsWith),
                                                            RandBetween(-25,-10),
                                                        theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "BNP"  && Text(theCurrentNode.inactiveColorMoveRecord.moveDirection) in "456",
                                                            RandBetween(-15,0),
                                                            
                                                        // default
                                                        0
                                                    ),
                                                GAME_PHASE_MIDDLE,
                                                    Switch(true,
                                                        IsMatch(theCurrentNode.inactiveColorMoveRecord.san, "O-O", MatchOptions.BeginsWith),
                                                            RandBetween(-25,-10),
                                                        theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "QBNP",
                                                            RandBetween(-15,0),
                                                        
                                                        // default
                                                        0
                                                    ),
                
                                                // default
                                                0
                                            )
                                        ),
                                    heuristic19:
                                        RandBetween(-8,8)
                
                                })
                        });
                
                        UpdateIf(colPF_MOVE_TREE, nodeID=pNodeID, {
                            postMoveEvalRecord: 
                                Patch(LookUp(colPF_MOVE_TREE, nodeID=pNodeID).postMoveEvalRecord, {
                                    centipawn:
                                        With(
                                            LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNodeUpdated,
                                            
                                            If(gblPF_DEBUG_EVAL,
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic11: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic11
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic12: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic12
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic15: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic15
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic16: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic16
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic18: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic18
                                                });
                                                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                                    " heuristic19 the God of Randomness BONUS/PENALTY sub-total: " & theCurrentNodeUpdated.postMoveEvalRecord.heuristic19
                                                })
                                            );
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic11 +
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic12 +
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic15 +
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic16 +
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic18 +
                                            theCurrentNodeUpdated.postMoveEvalRecord.heuristic19
                                        )
                                })
                        })
                    );
                
                    If(gblPF_DEBUG_EVAL,
                        With(
                            LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNode,
                
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                " fCE_600(): san: " & theCurrentNode.inactiveColorMoveRecord.san &
                                " pacn: " & theCurrentNode.inactiveColorMoveRecord.pacn &
                                " centipawn: " & theCurrentNode.postMoveEvalRecord.centipawn
                            })
                        )
                    )
                );
                
                If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & " fCE_600(): exiting"})
                )
                
    fCE_600_postEvaluate():
        ThisProperty:
            Default: |+
                =If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                        " comChessEngineFunctions.fCE_600_postEvaluate(): entered"
                    })
                );
                
                
                
                
                
                If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                        " comChessEngineFunctions.fCE_600_postEvaluate(): exiting"
                    })
                );
                
    fCE_600_preEvaluate():
        ThisProperty:
            Default: |+
                =If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                        " comChessEngineFunctions.fCE_600_preEvaluate(): entering"
                    })
                );
                
                
                With(
                    {
                        d0Node:         LookUp(colPF_MOVE_TREE, nodeDepth=0),
                        dynamicData:    LookUp(colPF_DYNAMIC_DATA, dataName=DYNAMIC_DATA_PF_NAME)
                    } As theData,
                
                If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                        " comChessEngineFunctions.fCE_600_preEvaluate(): DEBUG is c3 attacked by BLACK ?" &
                        " c3 isAttacked?: " & UDF_isSqNumAttacked(theData.d0Node.postMoveBoard, UDF_sqNameToSqNum("c3"), BLACK) &
                        " c3 isAttacked?: " &
                            UDF_isSqNumAttacked(
                                UDF_setBitAtSqNum(theData.d0Node.postMoveBoard, EMPTY_FILLER_ABBR, UDF_sqNameToSqNum("c3")),
                                UDF_sqNameToSqNum("c3"), 
                                BLACK
                            ) &
                        " c3 isPAWNAttacked?: " & UDF_isSqNumPAWNAttacked(theData.d0Node.postMoveBoard, UDF_sqNameToSqNum("c3"), BLACK)
                    })
                );
                
                    UpdateIf(colPF_DYNAMIC_DATA, dataName=DYNAMIC_DATA_PF_NAME, {
                        evalData:   Patch(LookUp(colPF_DYNAMIC_DATA, dataName=DYNAMIC_DATA_PF_NAME).evalData, {
                                        theirHangingSquaresSet:
                                            UDF_createSetOfSqNames(
                                                Concat(
                                                    ForAll(
                                                        Sequence(64,0) As theSqNum,
                
                                                        If(UDF_getBitAtSqNum(theData.d0Node.postMoveBoard, theSqNum.Value) exactin UDF_getICPieceABBR(theData.d0Node.postMoveFEN, BLACK_PIECES),
                                                            // THEN - check if it is protected (i.e., attacked by its own Color)
                                                            If(UDF_isSqNumAttacked(theData.d0Node.postMoveBoard, theSqNum.Value, UDF_FEN_TO_INACTIVE_COLOR(theData.d0Node.postMoveFEN)),
                                                                // THEN - not a weak square
                                                                "",
                
                                                                // ELSE - a weak square
                                                                UDF_sqNumToSqName(theSqNum.Value) & " "
                                                            )
                                                        )
                                                    ), Value
                                                )
                                            ),
                                        myHangingSquaresSet:
                                            UDF_createSetOfSqNames(
                                                Concat(
                                                    ForAll(
                                                        Sequence(64,0) As theSqNum,
                
                                                        If(UDF_getBitAtSqNum(theData.d0Node.postMoveBoard, theSqNum.Value) exactin UDF_getACPieceABBR(theData.d0Node.postMoveFEN, BLACK_PIECES),
                                                            // THEN - check if it is protected (i.e., attacked by its own Color)
                                                            If(UDF_isSqNumAttacked(theData.d0Node.postMoveBoard, theSqNum.Value, UDF_FEN_TO_ACTIVE_COLOR(theData.d0Node.postMoveFEN)),
                                                                // THEN - not a weak square
                                                                "",
                
                                                                // ELSE - a weak square
                                                                UDF_sqNumToSqName(theSqNum.Value) & " "
                                                            )
                                                        )
                                                    ), Value
                                                )
                                            )
                                    })
                    })
                );
                
                If(gblPF_DEBUG_EVAL,
                    With(
                        LookUp(colPF_DYNAMIC_DATA, dataName=DYNAMIC_DATA_PF_NAME) As theData,
                
                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                            " comChessEngineFunctions.fCE_600_preEvaluate(): DEBUG" &
                            " myHangingSquaresSet: " & theData.evalData.myHangingSquaresSet &
                            " theirHangingSquaresSet: " & theData.evalData.theirHangingSquaresSet
                        })
                    )
                );
                
                If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                        " comChessEngineFunctions.fCE_600_preEvaluate(): exiting"
                    })
                );
                
                
                /*
                    ForAll(
                        Sequence(64, 0) As theSqNum,
                
                        With(
                            {
                                occupier:       UDF_getBitAtSqNum(theData.d0Node.postMoveBoard, theSqNum.Value),
                                isAttacked:     UDF_isSqNumAttacked(theData.d0Node.postMoveBoard, theSqNum.Value, UDF_FEN_TO_ACTIVE_COLOR(theData.d0Node.postMoveFEN)),
                                isProtected:    UDF_isSqNumAttacked(theData.d0Node.postMoveBoard, theSqNum.Value, UDF_FEN_TO_INACTIVE_COLOR(theData.d0Node.postMoveFEN)),
                        Switch(true,
                
                
                        PF_EVAL_DATA_RECORD={
                            myHangingSquaresSet:            BLANK_BOARD,
                            theirHangingSquaresSet:         BLANK_BOARD,
                            myStrongSquaresBoard:       BLANK_BOARD,
                            theirStrongSquaresBoard:    BLANK_BOARD
                        };
                        
                        DYNAMIC_DATA_PF_NAME="DYNAMIC_DATA_PF";
                        
                        PF_DYNAMIC_DATA={
                            dataName:           DYNAMIC_DATA_PF_NAME,
                            chessEngineData:    PF_CHESS_ENGINE_DATA_RECORD,
                            uiData:             PF_UI_DATA_RECORD,
                            evalData:           PF_EVAL_DATA_RECORD
                        };
                 */
                /*
                If(gblPF_DEBUG_EVAL,
                    // THEN
                    With(
                        LookUp(colPF_DYNAMIC_DATA, dataName=DYNAMIC_DATA_PF_NAME) As theData,
                
                        With(
                            {
                                theCurrentMoveTreeNode: LookUp(colPF_MOVE_TREE, nodeID=pNodeID),
                                theParentMoveTreeNode:  LookUp(colPF_MOVE_TREE, nodeID=LookUp(colPF_MOVE_TREE, nodeID=pNodeID).parentNodeID),
                                theMoveHistoryTailNode:
                                    If(CountRows(colPF_MOVE_HISTORY)>=1,LookUp(colPF_MOVE_HISTORY, nodeID=theData.chessEngineData.moveHistoryTAILNodeID),Blank())
                            } As localVars,
                
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                " CountRows(colPF_MOVE_HISTORY): " & CountRows(colPF_MOVE_HISTORY)
                            });
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                " current nodeID: " & pNodeID &
                                " pacn: " & localVars.theCurrentMoveTreeNode.inactiveColorMoveRecord.pacn &
                                " preMove-active color: " & UDF_ColorToStr(UDF_FEN_TO_ACTIVE_COLOR(localVars.theCurrentMoveTreeNode.preMoveFEN)) &
                                " postMovePINs: " & localVars.theCurrentMoveTreeNode.postMovePINs
                            });
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                " parent nodeID: " & If(IsBlank(localVars.theParentMoveTreeNode),"Blank", localVars.theParentMoveTreeNode.nodeID) &
                                " pacn: " & If(IsBlank(localVars.theParentMoveTreeNode),"Blank", localVars.theParentMoveTreeNode.inactiveColorMoveRecord.pacn) &
                                " preMove-active color: " &
                                    If(IsBlank(localVars.theParentMoveTreeNode),"Blank", UDF_ColorToStr(UDF_FEN_TO_ACTIVE_COLOR(localVars.theParentMoveTreeNode.preMoveFEN))) &
                                " postMovePINs: " & If(IsBlank(localVars.theParentMoveTreeNode),"Blank", localVars.theParentMoveTreeNode.postMovePINs)
                            });
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                " History tail nodeID: " & If(IsBlank(localVars.theMoveHistoryTailNode),"Blank",localVars.theMoveHistoryTailNode.nodeID) &
                                " pacn: " &
                                    If(IsBlank(localVars.theMoveHistoryTailNode),"Blank",localVars.theMoveHistoryTailNode.inactiveColorMoveRecord.pacn) &
                                " preMove-active color: " &
                                    If(IsBlank(localVars.theMoveHistoryTailNode),"Blank",UDF_ColorToStr(UDF_FEN_TO_ACTIVE_COLOR(localVars.theMoveHistoryTailNode.preMoveFEN))) &
                                " postMovePINs: " & 
                                    If(IsBlank(localVars.theMoveHistoryTailNode),"Blank",localVars.theMoveHistoryTailNode.postMovePINs)
                            })
                        )
                    )
                );
                
                
                
                
                With(
                    LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNode,
                
                    With(
                        {
                            postMoveBoard:      UDF_FEN_TO_BOARD(theCurrentNode.postMoveFEN)
                        } As localVars,
                
                        If(gblPF_DEBUG_EVAL,
                            // THEN
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                " pre-update whiteStrongSqBoard: " & theCurrentNode.postMoveEvalRecord.whiteStrongSqBoard
                            });
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                " pre-update blackStrongSqBoard: " & theCurrentNode.postMoveEvalRecord.blackStrongSqBoard
                            });
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                " postMoveBoard: " & localVars.postMoveBoard
                            });
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                " postMovePINs: " & theCurrentNode.postMovePINs
                            })
                        );
                
                        If(IsBlank(theCurrentNode.postMoveEvalRecord.whiteStrongSqBoard),
                            // THEN - need to populate the whiteStrongSqBoard board
                            With(
                                {
                                    whiteStrongSqNameList:
                                        Concat(
                                            Distinct(
                                                Sort(
                                                    Split(
                                                        Trim(
                                                            Concat(
                                                                ForAll(
                                                                    Sequence(64,0) As theSqNum,
                
                                                                    With(
                                                                        {
                                                                            moveBit: UDF_getBitAtSqNum(localVars.postMoveBoard,theSqNum.Value) 
                                                                        } As theMoveBit,
                
                                                                        If(theMoveBit.moveBit=EMPTY_FILLER_ABBR || theMoveBit.moveBit exactin BLACK_PIECES,
                                                                            // THEN - there is no piece
                                                                            "",
                
                                                                            // THEN - we got a piece - get its' moves and filter them
                                                                            Concat(
                                                                                ForAll(
                                                                                    Filter(colPF_LEGAL_MOVES,
                                                                                        sqNum=theSqNum.Value &&
                                                                                        // the PAWN is case sensitive since it is uni-directional
                                                                                        pieceUpper= If(theMoveBit.moveBit in "P",theMoveBit.moveBit,Upper(theMoveBit.moveBit))
                                                                                    ) As theEligibleMove,
                
                                                                                    Switch(true,
                                                                                        // pawn forward moves do not capture therefore do not make strong squares
                                                                                        theMoveBit.moveBit in "P" && Text(theEligibleMove.theDirection) in "15",
                                                                                            "",
                
                                                                                        // castle moves do not capture therefore do not make strong squares
                                                                                        theEligibleMove.castle<>"-",
                                                                                            "",
                
                                                                                        // make sure slider squares are unoccupied
                                                                                        (!IsBlank(theEligibleMove.slideOvers)) &&
                                                                                            (!IsEmpty(
                                                                                                Filter(
                                                                                                    ForAll (
                                                                                                        Split(theEligibleMove.slideOvers, " ") As theSlideOverSqName,
                                                                                    
                                                                                                        If(
                                                                                                            UDF_getBitAtSqNum(
                                                                                                                localVars.postMoveBoard, 
                                                                                                                UDF_sqNameToSqNum(theSlideOverSqName.Value)
                                                                                                            ) in WHITE_PIECES, // any piece of any color in slide zone ?
                                                                                                            true,
                                                                                                            false
                                                                                                        )
                                                                                                    ), Value=true
                                                                                                )
                                                                                            )),
                                                                                            "",
                // /*
                //  * PIN rules
                // Rules:
                // to find PINs for preMove-active color look at the PINs in MOVE_TREE D0
                // to find PINs for preMove-inactive color look at the PINs in MOVE_HISTORY tail
                // - adjust if MOVE TREE D0 source square is in MOVE_HISTORY tail PIN list
                // -- if a MOVE_TREE D0 was a capture move - remove the MOVE TREE D0 source square from the MOVE_HISTORY tail PIN list
                // -- else replace the MOVE TREE D0 source square from the MOVE_HISTORY tail PIN list with the MOVE_TREE D0 target square
                //  * /
                                                                                        // default
                                                                                        theEligibleMove.eligibleSqName
                                                                                    )
                                                                                ), Value, " "
                                                                            )
                                                                        )
                                                                    )
                                                                ), Value, " "
                                                            )
                                                        ), " "
                                                    ), Value
                                                ), Value
                                            ), Value, " "
                                        )
                                } As theLists,
                
                                If(gblPF_DEBUG_EVAL,
                                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                        " comChessEngineFunctions.fME_prepNode(): DEBUG whiteStrongSqNameList: " & theLists.whiteStrongSqNameList
                                    });
                                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                        " comChessEngineFunctions.fME_prepNode(): DEBUG postMovePINs: " & theCurrentNode.postMovePINs &
                                        " postMovePINDirections: " & theCurrentNode.postMovePINDirections
                                    });
                                );
                
                                UpdateIf(colPF_MOVE_TREE, nodeID=pNodeID, {
                                    postMoveEvalRecord: 
                                        Patch(theCurrentNode.postMoveEvalRecord, {
                                            whiteStrongSqBoard: Concat(
                                                                    ForAll(
                                                                        Sequence(64,0) As theSqNum,
                
                                                                        If(UDF_sqNumToSqName(theSqNum.Value) in theLists.whiteStrongSqNameList, ATTACKED_ABBR, EMPTY_FILLER_ABBR)
                                                                    ), Value, ""
                                                                )
                                        })
                                })
                            )
                        );
                
                        If(IsBlank(theCurrentNode.postMoveEvalRecord.blackStrongSqBoard),
                            // THEN - need to populate the blackStrongSqBoard board
                            With(
                                {
                                    blackStrongSqNameList:
                                        Concat(
                                            Distinct(
                                                Sort(
                                                    Split(
                                                        Trim(
                                                            Concat(
                                                                ForAll(
                                                                    Sequence(64,0) As theSqNum,
                
                                                                    With(
                                                                        {
                                                                            moveBit: UDF_getBitAtSqNum(localVars.postMoveBoard,theSqNum.Value) 
                                                                        } As theMoveBit,
                
                                                                        If(theMoveBit.moveBit=EMPTY_FILLER_ABBR || theMoveBit.moveBit exactin WHITE_PIECES,
                                                                            // THEN - there is no piece
                                                                            "",
                
                                                                            // THEN - we got a piece - get its' moves and filter them
                                                                            Concat(
                                                                                ForAll(
                                                                                    Filter(colPF_LEGAL_MOVES,
                                                                                        sqNum=theSqNum.Value &&
                                                                                        // the PAWN is case sensitive since it is uni-directional
                                                                                        pieceUpper= If(theMoveBit.moveBit in "P",theMoveBit.moveBit,Upper(theMoveBit.moveBit))
                                                                                    ) As theEligibleMove,
                                                                                    
                                                                                    Switch(true,
                                                                                        // pawn forward moves do not capture therefore do not make strong squares
                                                                                        theMoveBit.moveBit in "P" && Text(theEligibleMove.theDirection) in "15",
                                                                                            "",
                
                                                                                        // castle moves do not capture therefore do not make strong squares
                                                                                        theEligibleMove.castle<>"-",
                                                                                            "",
                
                                                                                        // make sure slider squares are unoccupied
                                                                                        (!IsBlank(theEligibleMove.slideOvers)) &&
                                                                                            (!IsEmpty(
                                                                                                Filter(
                                                                                                    ForAll (
                                                                                                        Split(theEligibleMove.slideOvers, " ") As theSlideOverSqName,
                                                                                    
                                                                                                        If(
                                                                                                            UDF_getBitAtSqNum(
                                                                                                                localVars.postMoveBoard, 
                                                                                                                UDF_sqNameToSqNum(theSlideOverSqName.Value)
                                                                                                            ) in WHITE_PIECES, // any piece of any color in slide zone ?
                                                                                                            true,
                                                                                                            false
                                                                                                        )
                                                                                                    ), Value=true
                                                                                                )
                                                                                            )),
                                                                                            "",
                
                                                                                        // default
                                                                                        theEligibleMove.eligibleSqName
                                                                                    )
                                                                                ), Value, " "
                                                                            )
                                                                        )
                                                                    )
                                                                ), Value, " "
                                                            )
                                                        ), " "
                                                    ), Value
                                                ), Value
                                            ), Value, " "
                                        )
                                } As theLists,
                
                                If(gblPF_DEBUG_EVAL,
                                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                                        " comChessEngineFunctions.fME_prepNode(): DEBUG blackStrongSqList: " & theLists.blackStrongSqNameList
                                    })
                                );
                
                                UpdateIf(colPF_MOVE_TREE, nodeID=pNodeID, {
                                    postMoveEvalRecord: 
                                        Patch(theCurrentNode.postMoveEvalRecord, {
                                            blackStrongSqBoard: Concat(
                                                                    ForAll(
                                                                        Sequence(64,0) As theSqNum,
                
                                                                        If(UDF_sqNumToSqName(theSqNum.Value) in theLists.blackStrongSqNameList, ATTACKED_ABBR, EMPTY_FILLER_ABBR)
                                                                    ), Value, ""
                                                                )
                                        })
                                })
                            )
                        )
                    )
                );
                
                If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                        " comChessEngineFunctions.fME_prepNode(): exiting"
                    })
                );
                
                 */
                
                
    fME_END_GAME(pVersion As Number, pNodeID As Number):
        pVersion:
            Default: =100
        pNodeID:
            Default: =EMPTY_NODE_ID
        ThisProperty:
            Default: |
                =If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                        " comChessEngineFunctions.fME_END_GAME(): entered pVersion: " & pVersion &
                        " pNodeID: " & pNodeID
                    })
                );
                
                With(
                    LookUp(colPF_DYNAMIC_DATA, dataName=DYNAMIC_DATA_PF_NAME) As theData,
                
                    With(
                        LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNode,
                
                        If(gblPF_DEBUG_EVAL,
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                " fME_END_GAME(): san: " & theCurrentNode.inactiveColorMoveRecord.san &
                                " pacn: " & theCurrentNode.inactiveColorMoveRecord.pacn &
                                " move color: " & UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN) &
                                " captureSquareOccupier: " & theCurrentNode.inactiveColorMoveRecord.captureSquareOccupier
                            })
                        );
                
                        Sum(0,
                            With (
                                {
                                    ppd:    UDF_FEN_TO_PIECE_PLACEMENT(theCurrentNode.postMoveFEN),
                                    filterScreen: If(UDF_FEN_TO_INACTIVE_COLOR(theCurrentNode.postMoveFEN)=WHITE,"QRBNP","qrbnp")
                                } As localVars,
                
                                With(
                                    {
                                        totalOpponentMaterial: Sum(
                                                                ForAll(
                                                                    Split(localVars.ppd, "") As thePiece,
                
                                                                    UDF_getPieceCentipawnMaterialValue(thePiece.Value, localVars.filterScreen)
                                                                ),
                                                                Value
                                                            )
                                    } As localVars,
                
                                    If(localVars.totalOpponentMaterial<>0,
                                        // THEN
                                        0,
                
                                        // ELSE - we are playing against king only
                                        Sum(0,
                                            If(theCurrentNode.inactiveColorMoveRecord.sourceSquareOccupier in "P", 25, 0)
                                        )
                                    )
                                )
                            )
                        )
                    )
                );
                
                // no exit logging or will mess up return code
    fME_EvaluateMove(pNodeID As Number):
        pNodeID:
            Default: =EMPTY_NODE_ID
        ThisProperty:
            Default: |
                =
                If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                        " comChessEngineFunctions.fME_EvaluateMove(): entered pNodeID: " & pNodeID
                    })
                );
                
                With(
                    LookUp(colPF_DYNAMIC_DATA, dataName=DYNAMIC_DATA_PF_NAME) As theData,
                
                    With(
                        LookUp(colPF_MOVE_TREE, nodeID=pNodeID) As theCurrentNode,
                
                        If(gblPF_DEBUG_EVAL,
                            Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                " fME_EvaluateMove(): san: " & theCurrentNode.inactiveColorMoveRecord.san &
                                " pacn: " & theCurrentNode.inactiveColorMoveRecord.pacn &
                                " move color: " & UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN) &
                                " captureSquareOccupier: " & theCurrentNode.inactiveColorMoveRecord.captureSquareOccupier
                            })
                        );
                
                        // determine which player's turn it is, and then see what their computer setting is currently set to
                        With(
                            {
                                selectedEngine: If(UDF_FEN_TO_ACTIVE_COLOR(theCurrentNode.preMoveFEN)=WHITE, drpWhitePiecesCE.Selected.Value, drpBlackPiecesCE.Selected.Value)
                            } As theEngine,
                
                            If(gblPF_DEBUG_TIMERS,
                                If(IsBlank(LookUp(colPF_Timers, timerName="comChessEngineFunctions.fME_EvaluateMove")),
                                    Collect(colPF_Timers, {timerName:"comChessEngineFunctions.fME_EvaluateMove", startTime: Now(), stopTime: Blank() }),
                                    UpdateIf(colPF_Timers, timerName="comChessEngineFunctions.fME_EvaluateMove", { startTime: Now(), stopTime: Blank() })
                                )
                            );
                            
                            Switch(true,
                                theEngine.selectedEngine=CE_PF_200,
                                    If(gblPF_DEBUG_EVAL,
                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                            " fME_EvaluateMove(): calling comChessEngineFunctions.fCE_200(" & pNodeID & ")"
                                        })
                                    );
                                    comChessEngineFunctions.fCE_200(pNodeID),
                                theEngine.selectedEngine=CE_PF_300,
                                    If(gblPF_DEBUG_EVAL,
                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                            " fME_EvaluateMove(): calling comChessEngineFunctions.fCE_300(" & pNodeID & ")"
                                        })
                                    );
                                    comChessEngineFunctions.fCE_300(pNodeID),
                                theEngine.selectedEngine=CE_PF_400,
                                    If(gblPF_DEBUG_EVAL,
                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                            " fME_EvaluateMove(): calling comChessEngineFunctions.fCE_400(" & pNodeID & ")"
                                        })
                                    );
                                    comChessEngineFunctions.fCE_400(pNodeID),
                                theEngine.selectedEngine=CE_PF_500,
                                    If(gblPF_DEBUG_EVAL,
                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                            " fME_EvaluateMove(): calling comChessEngineFunctions.fCE_500(" & pNodeID & ")"
                                        })
                                    );
                                    comChessEngineFunctions.fCE_500(pNodeID),
                                theEngine.selectedEngine=CE_PF_600,
                                    comChessEngineFunctions.fCE_600_preEvaluate();
                                    If(gblPF_DEBUG_EVAL,
                                        Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                            " fME_EvaluateMove(): calling comChessEngineFunctions.fCE_600(" & pNodeID & ")"
                                        })
                                    );
                                    comChessEngineFunctions.fCE_600(pNodeID);
                                    comChessEngineFunctions.fCE_600_postEvaluate(),
                                    
                                // default
                                If(gblPF_DEBUG_EVAL,
                                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                        " fME_EvaluateMove(): calling comChessEngineFunctions.fCE_100(" & pNodeID & ")"
                                    })
                                );
                                comChessEngineFunctions.fCE_100(pNodeID)
                            );
                
                            If(gblPF_DEBUG_TIMERS,
                                UpdateIf(colPF_Timers, timerName="comChessEngineFunctions.fME_EvaluateMove", { stopTime: Now() });
                                With(
                                    LookUp(colPF_Timers, timerName="comChessEngineFunctions.fME_EvaluateMove") As theTimer,
                
                                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & 
                                        " comChessEngineFunctions.fME_EvaluateMove(): elapsed time " &
                                        Text(DateDiff(theTimer.startTime, theTimer.stopTime, TimeUnit.Milliseconds)/1000) & " seconds" &
                                        " selectedEngine: " & theEngine.selectedEngine
                                        
                                    })
                                )
                            )
                        )
                    )
                );
                
                
                
                Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") & " fME_EvaluateMove(): exiting"});
    fME_getGamePhase(pFEN As String):
        pFEN:
            Default: =""
        ThisProperty:
            Default: |
                =If(gblPF_DEBUG_EVAL,
                    Collect(colPF_logs, {logOffset: GET_LOG_INDEX, logEntry: Text(Now(), "mm/dd/yyyy hh:mm:ss.fff") &
                        " comChessEngineFunctions.fME_getGamePhase(): entered pFEN: " & pFEN
                    })
                );
                
                With (
                    {
                        board:  UDF_FEN_TO_BOARD(pFEN),
                        ppd:    UDF_FEN_TO_PIECE_PLACEMENT(pFEN)
                    } As theBoard,
                
                    With (
                        {
                            whiteTotalDevelopment: Sum(
                                                    If(UDF_getBitAtSqNum(theBoard.board,51)="P",0,1),
                                                    If(UDF_getBitAtSqNum(theBoard.board,52)="P",0,1),
                                                    If(UDF_getBitAtSqNum(theBoard.board,56)="R",0,1),
                                                    If(UDF_getBitAtSqNum(theBoard.board,57)="N",0,1),
                                                    If(UDF_getBitAtSqNum(theBoard.board,58)="B",0,1),
                                                    If(UDF_getBitAtSqNum(theBoard.board,59)="Q",0,1),
                                                    If(UDF_getBitAtSqNum(theBoard.board,60)="K",0,1),
                                                    If(UDF_getBitAtSqNum(theBoard.board,61)="B",0,1),
                                                    If(UDF_getBitAtSqNum(theBoard.board,62)="N",0,1),
                                                    If(UDF_getBitAtSqNum(theBoard.board,63)="R",0,1)
                                                ),
                            blackTotalDevelopment: Sum(
                                                    If(UDF_getBitAtSqNum(theBoard.board,11)="p",0,1),
                                                    If(UDF_getBitAtSqNum(theBoard.board,12)="p",0,1),
                                                    If(UDF_getBitAtSqNum(theBoard.board,0)="r",0,1),
                                                    If(UDF_getBitAtSqNum(theBoard.board,1)="n",0,1),
                                                    If(UDF_getBitAtSqNum(theBoard.board,2)="b",0,1),
                                                    If(UDF_getBitAtSqNum(theBoard.board,3)="q",0,1),
                                                    If(UDF_getBitAtSqNum(theBoard.board,4)="k",0,1),
                                                    If(UDF_getBitAtSqNum(theBoard.board,5)="b",0,1),
                                                    If(UDF_getBitAtSqNum(theBoard.board,6)="n",0,1),
                                                    If(UDF_getBitAtSqNum(theBoard.board,7)="r",0,1)
                                                ),
                            whiteTotalMaterial: Sum(
                                                    ForAll(
                                                        Split(theBoard.ppd, "") As thePiece,
                
                                                        UDF_getPieceCentipawnMaterialValue(thePiece.Value, "QRBNP")
                                                    ),
                                                    Value
                                                ),
                            blackTotalMaterial: Abs(
                                                    Sum(
                                                        ForAll(
                                                            Split(theBoard.ppd, "") As thePiece,
                
                                                            UDF_getPieceCentipawnMaterialValue(thePiece.Value, "qrbnp")
                                                        ),
                                                        Value
                                                    )
                                                )
                        } As theMaterial,
                
                        If(UDF_FEN_TO_ACTIVE_COLOR(pFEN)=WHITE,
                            // THEN
                            Switch(true,
                                Min(theMaterial.whiteTotalMaterial, theMaterial.blackTotalMaterial)>=3000 && 
                                theMaterial.whiteTotalDevelopment<5 &&
                                UDF_FEN_TO_FULLMOVE_COUNT(pFEN)<=10,
                                    GAME_PHASE_OPENING,
                                Min(theMaterial.whiteTotalMaterial, theMaterial.blackTotalMaterial)>=1700,
                                    GAME_PHASE_MIDDLE,
                
                                // default
                                GAME_PHASE_END
                            ),
                
                            // ELSE
                            Switch(true,
                                Min(theMaterial.whiteTotalMaterial, theMaterial.blackTotalMaterial)>=3000 && 
                                theMaterial.blackTotalDevelopment<5 &&
                                UDF_FEN_TO_FULLMOVE_COUNT(pFEN)<=10,
                                    GAME_PHASE_OPENING,
                                Min(theMaterial.whiteTotalMaterial, theMaterial.blackTotalMaterial)>=1700,
                                    GAME_PHASE_MIDDLE,
                
                                // default
                                GAME_PHASE_END
                            )
                        )
                    )
                );
    Fill: =RGBA(0, 0, 0, 0)
    Height: =640
    Width: =640
    X: =0
    Y: =0
    ZIndex: =1

